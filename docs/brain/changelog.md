2025-12-15T17:30:00Z | Copilot | CHANGE: Removed "Don't show again" button from help components. Help is now fully voluntary - user clicks ❓ to view modal, clicks backdrop or X to close. Removed isDismissed state, localStorage persistence logic, and handleDismiss functions from both InlineExplainer and WorkflowGuide. Simplified component state and eliminated unnecessary persistence. Updated brain file docs/brain/facilitator-help-system.md. Files: src/components/FacilitatorHelp/InlineExplainer.jsx, src/components/FacilitatorHelp/WorkflowGuide.jsx, docs/brain/facilitator-help-system.md.
2025-12-15T17:15:00Z | Copilot | FIX: Fixed modal overlay rendering by replacing Tailwind CSS classes with inline styles. Tailwind classes were not displaying modals properly. Inline styles ensure backdrop and modal box display correctly with guaranteed z-index, positioning, and colors. Files: src/components/FacilitatorHelp/InlineExplainer.jsx, src/components/FacilitatorHelp/WorkflowGuide.jsx.
2025-12-15T16:50:00Z | Copilot | CHANGE: Unified help component icons - both InlineExplainer and WorkflowGuide now use ❓ emoji for consistency. Single icon pattern across all help modals prevents user confusion and maintains visual coherence. Files: src/components/FacilitatorHelp/WorkflowGuide.jsx, docs/brain/facilitator-help-system.md.
2025-12-15T16:45:00Z | Copilot | CHANGE: Refactored WorkflowGuide from inline collapsible to modal overlay. Changed from full-width blue box with clipboard SVG and dropdown arrow to emoji button. Removed defaultOpen prop (modal controlled by user click, not component mount). Modal implementation matches InlineExplainer pattern: emoji button → centered modal with backdrop → close via backdrop click or X button. Prevents inline collapsible blocks from disrupting page layout and taking excessive vertical space. Updated brain file docs/brain/facilitator-help-system.md with new component architecture, removed defaultOpen from lessons page WorkflowGuide. Files: src/components/FacilitatorHelp/WorkflowGuide.jsx, src/app/facilitator/lessons/page.js, docs/brain/facilitator-help-system.md.
2025-12-15T16:30:00Z | Copilot | CHANGE: Refactored InlineExplainer to use modal overlay instead of positioned tooltip. Changed button from blue circle with SVG to ❓ emoji for clearer affordance. Modal centers on screen with backdrop, preventing messy layout issues and overflow. Removed placement prop from all InlineExplainer instances (no longer needed). Updated brain file docs/brain/facilitator-help-system.md with design decision rationale. Files: src/components/FacilitatorHelp/InlineExplainer.jsx, src/app/facilitator/calendar/page.js, src/app/facilitator/calendar/LessonPlanner.jsx, src/app/facilitator/learners/page.js, src/app/facilitator/learners/components/LearnerEditOverlay.jsx, docs/brain/facilitator-help-system.md.
2025-12-15T16:00:00Z | Copilot | FEATURE: Implemented facilitator help system to address beta tester confusion. Created InlineExplainer (dismissible tooltip), WorkflowGuide (collapsible step guide), PageHeader (consistent page header) components in src/components/FacilitatorHelp/. Added contextual help to calendar page (tab explainers, color legend, workflow guide for planner), learners page (targets/AI/timers explainers), lessons page (approve vs schedule workflow), LessonPlanner (weekly pattern explainer), LearnerEditOverlay (phase timers explanation). All help dismissals persist in localStorage. Created brain file docs/brain/facilitator-help-system.md documenting component architecture, placement strategy, content guidelines, and What NOT To Do. Updated manifest.json with facilitator-help-system entry. Files: src/components/FacilitatorHelp/{InlineExplainer.jsx,WorkflowGuide.jsx,PageHeader.jsx,index.js}, src/app/facilitator/calendar/page.js, src/app/facilitator/calendar/LessonPlanner.jsx, src/app/facilitator/learners/page.js, src/app/facilitator/learners/components/LearnerEditOverlay.jsx, src/app/facilitator/lessons/page.js, docs/brain/facilitator-help-system.md, docs/brain/manifest.json.
2025-12-15T03:50:00Z | Copilot | FIX: Edit Lesson - strip generated/ prefix from file parameter. lesson_key in schedule includes 'generated/' prefix (added by LessonPicker/LessonGeneratorOverlay for routing), but actual storage path is flat facilitator-lessons/{userId}/{filename} without subfolder. Generate API stores files without generated/ prefix in storage path. Added file.replace(/^generated\//, '') to strip prefix before constructing storagePath. Files: src/app/api/facilitator/lessons/get/route.js (strip generated/ prefix from file parameter).
2025-12-15T03:45:00Z | Copilot | FIX: Edit Lesson - use direct createClient like lesson-file route. Direct REST API still returned 400. Found lesson-file route successfully uses SDK .download() with createClient(url, svc, {auth: {persistSession: false}}). Changed from getSupabaseAdmin() helper and REST API back to SDK download() but with direct createClient pattern matching working route. Simplified client creation to match proven pattern. Files: src/app/api/facilitator/lessons/get/route.js (removed getSupabaseAdmin, added createClient import, use SDK download with direct client creation).
2025-12-15T03:40:00Z | Copilot | FIX: Edit Lesson 400 error - missing URL encoding. Direct REST API call returned 400 Bad Request. Storage path includes subfolders (generated/filename.json) that need proper URL encoding. Added path.split('/').map(encodeURIComponent).join('/') to encode each path segment while preserving slashes. Files: src/app/api/facilitator/lessons/get/route.js (added encodedPath with encodeURIComponent for each segment).
2025-12-15T03:35:00Z | Copilot | FIX: Edit Lesson 404 - SDK download() fails, use direct REST API. Supabase Storage SDK .download() method returns StorageUnknownError with no specific status. Found list route uses direct fetch with service role key instead of SDK, which works. Changed download from supabase.storage.from('lessons').download(path) to direct fetch(`${SUPABASE_URL}/storage/v1/object/lessons/${path}`) with Authorization and apikey headers. Matches working pattern in lessons/list route. SDK issue bypassed. Files: src/app/api/facilitator/lessons/get/route.js (replaced SDK download with direct REST API fetch).
2025-12-15T03:30:00Z | Copilot | DEBUG: Expand error logging to capture all downloadError properties. details field only showed URL, not actual error reason. Added logging for message, name, status, statusCode, and full JSON.stringify of error object. Return errorMessage and errorStatus in response body. Will reveal what specific error Supabase Storage is returning (404, 403, RLS block, etc). Files: src/app/api/facilitator/lessons/get/route.js (expanded console.error and response body with all error properties).
2025-12-15T03:25:00Z | Copilot | DEBUG: Use JSON.stringify for error logging. Console.error with object didn't expand to show properties. Changed to JSON.stringify(errorData, null, 2) so details/path fields from API response are visible in browser console. Files: src/app/facilitator/calendar/DayViewOverlay.jsx (added JSON.stringify to console.error in handleEditClick).
2025-12-15T03:20:00Z | Copilot | DEBUG: Log API error response in client code. Server-side console.error logs don't show in browser console. Client code wasn't logging response body from 404 error, only generic "Failed to load lesson" message. Added errorData extraction from response.json() and console.error logging before throwing error. Will reveal details/path fields added to API response. Files: src/app/facilitator/calendar/DayViewOverlay.jsx (added await response.json() and console.error for errorData in handleEditClick).
2025-12-15T03:15:00Z | Copilot | DEBUG: Added error logging to lesson GET API to diagnose 404. Previous fixes (endpoint, response structure, userId) didn't resolve 404. User confirms file exists in storage. Added console.error logging in API to capture downloadError message, and return error details + path in 404 response body. Will reveal whether issue is RLS policy, bucket permissions, path encoding, or other storage access problem. Files: src/app/api/facilitator/lessons/get/route.js (added console.error with storagePath/bucket/error, added details/path fields to 404 response).
2025-12-15T03:10:00Z | Copilot | FIX: Edit Lesson still 404 - wrong userId lookup. Previous fixes corrected endpoint and response structure but used wrong userId. Scheduled lessons have a facilitator_id field (who created/owns the lesson file), but code was using current authenticated user's ID. This caused 404 when viewing someone else's scheduled lessons or when the lesson was created by a different account. Changed to use scheduledLesson.facilitator_id instead of getUser() call. Removed unnecessary Supabase auth call. Lesson files are stored at facilitator-lessons/{facilitator_id}/{lesson_key}, so must use the lesson's owner ID, not viewer ID. Files: src/app/facilitator/calendar/DayViewOverlay.jsx (removed Supabase getUser call, use scheduledLesson.facilitator_id for userId parameter).
2025-12-15T03:05:00Z | Copilot | FIX: Edit Lesson loading immediately after starting. Previous fix corrected endpoint but used wrong response structure. API `/api/facilitator/lessons/get` returns lesson object directly (`return NextResponse.json(lesson)`), not wrapped in `{lesson: ...}`. Code expected `data.lesson` causing undefined data. Changed to use `data` directly, matching pattern in session page. Lesson editor now loads successfully. Files: src/app/facilitator/calendar/DayViewOverlay.jsx (changed setLessonEditorData(data.lesson) to setLessonEditorData(data)).
2025-12-15T03:00:00Z | Copilot | FIX: Edit Lesson button failing with "failed to load lesson for editing". Button used incorrect API endpoint `/api/facilitator/lessons/{lessonKey}` (path parameter pattern) but API expects `/api/facilitator/lessons/get?file=X&userId=Y` (query parameter pattern). Added authentication to get userId, construct query params with file and userId, call correct endpoint. Matches pattern used in session page and GeneratedLessonsOverlay. Files: src/app/facilitator/calendar/DayViewOverlay.jsx (updated handleEditClick to get user from Supabase auth, build query params, use /api/facilitator/lessons/get endpoint).
2025-12-15T02:45:00Z | Copilot | PROTOCOL FIX: Strengthened brain file enforcement to prevent skipping. Previous language "on each response, automatically update" allowed loophole where code changes could be committed before brain updates. Added explicit SEQUENCE requirement: "Code edit → Brain file update → Changelog entry → Commit/push". Added "NEVER commit code changes without updating the brain file first" directive. Changed CRITICAL GUARDRAILS to mandate "Brain updates happen BEFORE commits (not after, not when user asks - immediately after code changes)". This ensures brain files are always updated in the same response as code changes, not deferred to next turn. Files: .github/copilot-instructions.md (rewrote DOCUMENT step with mandatory sequence, updated CRITICAL GUARDRAILS with explicit timing requirement).
2025-12-15T02:30:00Z | Copilot | CHANGE: Planned lessons now use date-specific overwrite instead of full replacement. Previously, generating a new lesson plan deleted ALL existing planned lessons for learner, preventing multiple non-overlapping plans from coexisting. Now only deletes dates that are in the new plan, allowing users to schedule multiple months that don't overlap (e.g., schedule January, then schedule March - both persist). If new plan includes dates with existing lessons, those specific dates are overwritten. Enables incremental planning and filling gaps in curriculum without losing unrelated dates. Updated brain file calendar-lesson-planning.md (Persistence Model, API Endpoints, What NOT To Do, Key Files, Recent Changes sections). Updated manifest.json timestamp and keywords. Files: src/app/api/planned-lessons/route.js (changed delete operation to extract newPlanDates from request body, use .in('scheduled_date', newPlanDates) filter instead of deleting all learner's planned lessons), docs/brain/calendar-lesson-planning.md (rewrote persistence model, API description, guidelines, added Recent Changes entry), docs/brain/manifest.json (updated timestamp, added date-specific overwrite keyword).
2025-12-15T02:15:00Z | Copilot | FIX: Lesson planner repeating topics. GPT instructions insufficiently explicit about avoiding repetition. Added prominent "CRITICAL: AVOID ALL REPETITION" section before guidelines. Explicitly states already-covered lessons must NOT be repeated even with slight variations (e.g., if "Addition" covered, cannot do "Addition Practice" or "More Addition"). Instructs to progress to NEXT concept in subject sequence. Provides concrete example progression (Fractions Intro → Comparing Fractions → Adding Fractions). Emphasizes "entirely NEW lessons on DIFFERENT topics" and "Each new lesson must advance to a NEW topic not yet covered". Stronger, more explicit language replaces previous brief bullet point. Files: src/app/facilitator/calendar/LessonPlanner.jsx (rewrote curriculum guidelines section lines 382-391 with emphatic anti-repetition instructions).
2025-12-15T02:00:00Z | Copilot | FEATURE: Adaptive difficulty progression for lesson planner. System now analyzes last 6 completed lessons to recommend appropriate difficulty level. Calculates average score and detects current level from lesson keywords (beginner/introduction/basics vs advanced/expert/mastery). Moves UP to advanced if avg ≥80-85% and appropriate current level. Moves DOWN to beginner if avg ≤65%, or to intermediate if avg ≤70% while at advanced. Defaults to intermediate with <3 completed lessons. Replaces hardcoded 'intermediate' with calculated recommendedDifficulty. Enhanced GPT instructions with "Curriculum Evolution Guidelines" emphasizing sequential building, no repetition, logical progressions, and staying at same level 3-4 lessons before advancing. System now responsive to both improvement (slow upward) and struggle (quick downward). Files: src/app/facilitator/calendar/LessonPlanner.jsx (added difficulty calculation logic lines 345-384, updated fetch body to use recommendedDifficulty).
2025-12-15T01:20:00Z | Copilot | FIX: Build failure - incorrect Supabase import path. Import path '@/lib/supabase' does not exist in project. Corrected to '@/app/lib/supabaseClient' matching pattern used throughout codebase (TutorialGuard, PostLessonSurvey, session page, etc). Build now completes successfully. Files: src/app/facilitator/calendar/DayViewOverlay.jsx (corrected getSupabaseClient import path).
2025-12-15T01:15:00Z | Copilot | FIX: Redo button failing with 401 Unauthorized error. Redo button fetch call to /api/generate-lesson-outline did not include Authorization header with auth token. API endpoint requires Bearer token for authentication (checks request.headers.authorization). Added getSupabaseClient import to DayViewOverlay, modified handleRedoClick to fetch session token via supabase.auth.getSession() before API call, added 'Authorization': `Bearer ${token}` header to fetch request. Redo button now successfully regenerates lesson outlines. Files: src/app/facilitator/calendar/DayViewOverlay.jsx (imported getSupabaseClient, updated handleRedoClick to get auth token and include in headers).
2025-12-15T01:00:00Z | Copilot | FEATURE: Implemented color differentiation for scheduled vs planned lessons in calendar. Scheduled lessons display in orange (#fef3c7 bg, #f59e0b indicator), planned lessons display in blue (#dbeafe bg, #3b82f6 indicator). Added isPlannedView prop to LessonCalendar component that determines which color scheme to use. Updated date cell background color logic and indicator dot color to conditionally apply blue for planned view or orange for scheduled view. Calendar page passes isPlannedView={activeTab === 'planner'} prop based on current tab. Visual distinction makes it immediately clear whether viewing scheduled curriculum or planning future lessons. Files: src/app/facilitator/calendar/LessonCalendar.js (added isPlannedView prop, updated background color logic to conditional ternary, updated indicator dot background to conditional), src/app/facilitator/calendar/page.js (passed isPlannedView prop based on activeTab).
2025-12-15T00:45:00Z | Copilot | PROTOCOL UPDATE: Made brain file checking universal and mandatory in Read-First Protocol. Changed from conditional ("before making changes to core systems") to sequential requirement on every task: (1) Check manifest.json first, (2) Read brain file if exists - it's canonical truth, (3) Scan code files for implementation details, (4) Read changelog. Added "Research mode" to workflow modes emphasizing brain-first approach. Brain file check now positioned as opening move of every task, parallel to how changelog updates are universal. This ensures brain files are consulted before code files, preventing drift and leveraging documented patterns/gotchas. Files: .github/copilot-instructions.md (updated Code/Debug/Record Workflow section, rewrote Read-First Protocol with numbered sequence).
2025-12-15T00:30:00Z | Copilot | FEATURE: Added Redo and Remove buttons for planned lessons in day view overlay. Redo button regenerates lesson outline with new title/description while keeping same subject/grade/difficulty. Remove button deletes planned lesson from that specific date with confirmation dialog. Both operations automatically save to database via savePlannedLessons. Added handlePlannedLessonUpdate and handlePlannedLessonRemove callbacks in calendar page, passed to DayViewOverlay. Redo button shows loading state while regenerating. Files: src/app/facilitator/calendar/DayViewOverlay.jsx (added onPlannedLessonUpdate/onPlannedLessonRemove props, added redoingLesson state, added handleRedoClick/handleRemoveClick functions, updated planned lesson card UI with 3-button vertical layout), src/app/facilitator/calendar/page.js (added handlePlannedLessonUpdate/handlePlannedLessonRemove functions, passed callbacks to DayViewOverlay).
2025-12-15T00:15:00Z | Copilot | FEATURE: Added month navigation arrows to calendar header. Added left/right arrow buttons immediately after year dropdown that navigate through months. Left arrow goes to previous month, right arrow advances to next month. Buttons automatically handle year transitions when moving past December or before January. Provides quick month navigation without opening dropdown menus. Files: src/app/facilitator/calendar/LessonCalendar.js (added handleMonthUp/handleMonthDown functions, added arrow button UI in horizontal flexbox after year selector).
2025-12-15T00:00:00Z | Copilot | FEATURE: Planned lessons now persist across sessions. Added database persistence for generated lesson plans - survives refresh, long absences, logout/login. Created planned_lessons table (facilitator_id, learner_id, scheduled_date, lesson_data JSONB). Created /api/planned-lessons route (GET loads by learner, POST saves plan replacing existing, DELETE clears plan). Modified calendar page to load planned lessons on mount/learner change, save after generation via new savePlannedLessons function. Planned lessons now treated like scheduled lessons - persist in database, not just component state. Created calendar-lesson-planning.md brain file documenting generation flow, persistence model, API endpoints, error handling, and data formats. Updated manifest.json with calendar-lesson-planning entry. Files: supabase/migrations/20251214000000_add_planned_lessons_table.sql (NEW table + RLS), src/app/api/planned-lessons/route.js (NEW API route), src/app/facilitator/calendar/page.js (added loadPlannedLessons, savePlannedLessons, wired to useEffect and LessonPlanner callback), docs/brain/calendar-lesson-planning.md (NEW brain file), docs/brain/manifest.json (added calendar-lesson-planning entry).
2025-12-14T23:15:00Z | Copilot | FIX: Lesson plan generation still failing - scheduled lessons API response structure mismatch. API returns {schedule: [...]} object but code expected raw array, causing ".map is not a function" error when processing scheduled lessons. Changed scheduledData.schedule extraction instead of treating whole response as array. Generation now correctly processes scheduled lessons from API response structure. Files: src/app/facilitator/calendar/LessonPlanner.jsx (line 285, changed scheduled to scheduledData.schedule).
2025-12-14T23:00:00Z | Copilot | FIX: Lesson plan generation failing with ".map is not a function" error. Code fetched medals from wrong API endpoint (/api/learner/medals instead of /api/medals) causing 404, then tried to use undefined medals object. When medals API failed, history processing crashed because medals was undefined. Fixed: (1) Changed medals fetch to correct /api/medals endpoint. (2) Decoupled medals from history check - process history if historyRes.ok, load medals separately if medalsRes.ok, default to empty object if medals unavailable. Generation now continues even if medals API fails. Files: src/app/facilitator/calendar/LessonPlanner.jsx (lines 241-265, fixed medals endpoint and error handling).
2025-12-14T22:40:00Z | Copilot | BRAIN FILE PROTOCOL UPDATE: Changed brain documentation requirement from conditional ("after code changes") to universal ("on each response") trigger matching changelog pattern. Added explicit escape clause: "If no code changes were made in this response, inform user and skip brain update." This makes brain updates as automatic as changelog entries while preventing unnecessary documentation when only discussing or researching. Updated CRITICAL GUARDRAILS section with "On each response" check and "If no changes" clause. Files: .github/copilot-instructions.md (BRAIN FILE PROTOCOL step 4, CRITICAL GUARDRAILS section).
2025-12-14T22:15:00Z | Copilot | FIX: Weekly Schedule Pattern horizontal overflow on mobile portrait. Pattern used fixed 7-column grid causing each day column to shrink to ~40px width on 375px mobile screens, resulting in overflow and unusable buttons. Added responsive CSS with breakpoint: single-column stacked layout on mobile (≤600px), 7-column grid on desktop (>600px). Reduced day column padding from 12px to 8px on mobile for better space usage. Pattern now readable and usable on mobile portrait while preserving week-view grid on larger screens. Files: src/app/facilitator/calendar/LessonPlanner.jsx (added weekly-pattern-grid and day-column CSS classes with media queries, removed inline styles).
2025-12-11T00:35:00Z | Copilot | FIX: Platform Jumper jump unreliable - player losing ground state while standing on platform. Collision detection only triggered when newVelY > 0 (falling). When standing still, velocity was 0, so collision check failed and !landed && onGroundRef caused immediate ground state loss. This created race condition where onGroundRef flickered between true/false every frame while standing still, making jump button miss most presses. Changed collision check from newVelY > 0 to newVelY >= 0 to include standing (velocity = 0). Now player maintains solid ground state while standing on platform. Jump button 100% reliable. Files: PlatformJumper.jsx (changed > to >= in collision velocity check).
2025-12-11T00:30:00Z | Copilot | FIX: Platform Jumper jump completely broken - simplified jump logic back to basics. Over-complicated state management with isJumping checks broke everything. Reverted to simple approach: performJump only checks onGroundRef (removed isJumping check entirely). When jump pressed, if on ground, apply velocity and immediately set onGround=false. Game loop sets onGround=true when landing. No complex velocity-based clearing or state machine. Jump button now works with single simple condition. Files: PlatformJumper.jsx (removed !isJumpingRef check from performJump, removed velocity-based isJumping clearing from game loop, performJump sets onGround=false immediately).
2025-12-11T00:25:00Z | Copilot | FIX: Platform Jumper jump completely non-responsive after clearing isJumping too aggressively. Previous fix cleared isJumpingRef every frame when !landed, including while jumping UPWARD. This caused isJumpingRef to be false even during upward jump motion, breaking the jump state machine. Changed to only clear isJumpingRef when falling (newVelY >= 0), not when jumping up (newVelY < 0). Now jump logic: press jump → isJumping=true → jump upward → reach peak → start falling → clear isJumping → land → can jump again. Files: PlatformJumper.jsx (added newVelY >= 0 condition to isJumping clearing).
2025-12-11T00:20:00Z | Copilot | FIX: Platform Jumper jump button only responding to first of multiple rapid clicks. isJumpingRef was set to true on jump but only cleared when landing on platform. Rapid button presses while in air all failed the !isJumpingRef check in performJump. Added logic to clear isJumpingRef whenever player is in air (not landed). Now isJumping flag is cleared as soon as player leaves ground, making jump available again immediately upon next landing. Jump button now responds to every press when on ground, even rapid-fire clicks. Files: PlatformJumper.jsx (added isJumpingRef.current=false when !landed in game loop).
2025-12-11T00:15:00Z | Copilot | FIX: Platform Jumper requiring double-tap to jump after first jump. performJump was setting onGroundRef.current=false after setting jump velocity, interfering with game loop physics. When landing, collision detection set onGroundRef=true and isJumpingRef=false, but on next jump button press, performJump set onGroundRef=false. This caused collision detection's "leaving ground" check to fail, keeping player in inconsistent state requiring extra press. Removed onGround manipulation from performJump - only set jump velocity and isJumping flag. Game loop physics now solely responsible for onGround state based on collision detection. Files: PlatformJumper.jsx (removed setOnGround and onGroundRef=false from performJump).
2025-12-11T00:10:00Z | Copilot | FIX: Platform Jumper onGround detection delayed by almost a second after landing. Game loop used onGround state to check gravity, but state updates are async. When player landed, onGroundRef was set inside setState callback (async), then gravity calculation on next frame still used old state value. Changed game loop to use onGroundRef.current everywhere instead of onGround state. Refs update IMMEDIATELY during collision detection before setState. Jump now available instantly on landing instead of ~1 second delay. Files: PlatformJumper.jsx (game loop gravity check uses ref, collision detection updates refs before state, leaving ground check uses ref).
2025-12-11T00:05:00Z | Copilot | FIX: Platform Jumper jump button only working 50% of the time - stale closure bug. performJump callback captured stale onGround/isJumping state values from when callback was created, not current values when button clicked. Added onGroundRef and isJumpingRef to track immediate state. performJump now checks refs (always current) instead of state (stale in closure). All state setters now update both state and ref to keep synchronized. Empty dependency array on performJump since refs never go stale. Files: PlatformJumper.jsx (added onGroundRef/isJumpingRef, updated performJump to use refs, synced all setOnGround/setIsJumping calls to update refs).
2025-12-10T23:55:00Z | Copilot | FIX: Platform Jumper jump button text selection and missed clicks. Jump button caused text highlighting on hold and didn't respond reliably. Added full event handlers (onPointerUp/Leave/Cancel, onContextMenu, onMouseDown, onTouchStart) with preventDefault and stopPropagation to match movement buttons. Added userSelect none to TouchControls wrapper divs to prevent text selection bleed. Files: PlatformJumper.jsx (added missing event handlers to jump button, added userSelect styles to wrapper divs).
2025-12-10T23:45:00Z | Copilot | FIX: Platform Jumper choppy controls - unified input system eliminates competing state updates between keyboard and touch. Touch movement intervals removed, replaced with refs (touchLeft/touchRight) matching keyboard pattern. Game loop now single source for all position updates, checks both keysPressed and touch refs. Shared performJump function prevents duplicate jump logic. Movement and jump now fully parallel - no conflicts during simultaneous input. Files: PlatformJumper.jsx (removed interval refs/functions, added touch refs, consolidated game loop movement logic, created performJump callback, simplified touch handlers to toggle refs).
2025-12-10T23:15:00Z | Copilot | FIX: AI feature toggles in learner settings not respected in session - disabling Ask/Poem/Story/Fill-in-Fun per learner had no effect. Root cause: Session page never loaded or checked learner's ask_disabled, poem_disabled, story_disabled, fill_in_fun_disabled fields from database. Added state variables for each toggle, loaded from learner profile on mount and storage change, conditionally hide disabled feature buttons in both Opening action button groups. askFeatureAllowed now checks both tier entitlement AND learner-specific ask_disabled flag. Files: src/app/session/page.js (added 4 disabled state variables, load from learner on mount + storage change, updated askFeatureAllowed to check askDisabled, wrapped Poem/Story/Fill-in-Fun buttons in conditional render based on disabled flags).
2025-12-10T22:30:00Z | Copilot | Removed stale word avoidance rule - Ms. Sonoma can now naturally say "test", "worksheet", etc.; updated constants.js and brain docs
2025-12-10T01:00:00Z | Copilot | FEATURE: Unified account page with overlay-based settings. Completely restructured /facilitator/account page to consolidate all account management in one place with consistent overlay pattern. Replaced linear sections with 10 clickable heading cards in responsive grid: Your Name, Email and Password, Two-Factor Auth, Facilitator PIN, Connected Accounts, Hotkeys, Timezone, Marketing Emails, Policies, Plan, Danger Zone. Each card opens modal overlay (SettingsOverlay component) with focused settings UI. Created SettingsOverlay.jsx reusable modal component (fixed position, backdrop click to close, Escape key support, body scroll lock, consistent header/body/footer layout). Implemented 10 individual overlay components with full state management and API integration: (1) NameOverlay - display name editing, saves to profiles.full_name + auth metadata, (2) PasswordOverlay - shows email (read-only) + change password link, (3) TwoFactorOverlay - TOTP enrollment with QR code, verify/unenroll, (4) PinOverlay - 4-8 digit PIN + 6 preference checkboxes, /api/facilitator/pin integration, (5) ConnectedAccountsOverlay - Google OAuth link/unlink with ?rts redirect handling, (6) HotkeysOverlay - redirects to /facilitator/hotkeys full page, (7) TimezoneOverlay - dropdown with 10 timezones, /api/profile/timezone, (8) MarketingOverlay - opt-in checkbox, saves to profiles + auth metadata, (9) PoliciesOverlay - links to privacy/terms/data with card layout, (10) PlanOverlay - redirects to /facilitator/account/plan, (11) DangerZoneOverlay - two-step account deletion with /api/user/delete. Redirected old /facilitator/account/settings page to account page (simple redirect component). All settings lazy-load on overlay open (not on page load). OAuth/Stripe redirects properly handled (BFCache for Stripe, ?rts cleanup for Google). Mobile responsive (overlay modals adapt to small screens). All functionality migrated from scattered pages into unified interface. Files: src/components/SettingsOverlay.jsx (NEW - reusable modal), src/app/facilitator/account/page.js (complete restructure - 10 heading cards + 11 overlay components), src/app/facilitator/account/settings/page.js (redirect to account page).
2025-12-10T00:30:00Z | Copilot | FEATURE: Implemented learner selection dropdown for Notes, Schedule, and Assign buttons in lesson editor. All three buttons now show learner selection overlay, load facilitator's learners list, allow selection, then open functional modals with learner context. Notes modal: Textarea for editing lesson notes, loads existing note from learner's lesson_notes, saves to database, updates learner list on save. Schedule modal: Date picker defaulting to today, calls /api/lesson-schedule to schedule lesson for selected learner on chosen date. Assign modal: Toggle lesson availability for selected learner, loads current assignment status from approved_lessons, saves updates to database, shows grant/remove access buttons with status-based styling. All modals show learner name + lesson title, have proper save/cancel actions with loading states. Learner selection dropdown shared across all three actions with context-aware prompt text. Files: src/app/facilitator/lessons/edit/page.js (added learner loading useEffect, showLearnerSelect state, selectedLearnerId/selectedLearner states, learner selection modal, full Notes/Schedule/Assign implementations replacing placeholders).
2025-12-10T00:15:00Z | Copilot | FEATURE: Add Notes, Schedule, Assign, and Delete buttons to lesson editor. Added four action buttons in the LessonEditor header after the Save button: (1) Notes button - shows modal explaining notes require learner context (use main Lessons page). (2) Schedule button - shows modal explaining scheduling requires learner context (use main Lessons page). (3) Assign button - shows modal explaining assignment requires learner list context (use main Lessons page). (4) Delete button - functional delete with confirmation overlay, only works for generated lessons, deletes from Supabase Storage and redirects to lessons page. Notes/Schedule/Assign are placeholders directing users to the main Lessons page where learner context is available. Delete is fully functional for generated lessons with confirmation dialog. Files: src/components/LessonEditor.jsx (added onNotes/onSchedule/onAssign/onDelete props, added four buttons in header), src/app/facilitator/lessons/edit/page.js (added state for modals, added handlers, added four modal overlays with delete implementation).
2025-12-10T00:05:00Z | Copilot | FIX: Beta users blocked from lesson validation auto-fix with 403 error. The /api/facilitator/lessons/request-changes route (used for automatic quality validation fixes after generation) had same issue as generate route - only queried plan_tier and hardcoded check for plan_tier !== 'premium'. When Beta users generated lessons with quality issues, the auto-fix step failed with 403, preventing lesson optimization. Applied same Beta tier resolution pattern: (1) Import resolveEffectiveTier and featuresForTier. (2) Query both subscription_tier and plan_tier. (3) Resolve effective tier (Beta→Plus). (4) Check features.facilitatorTools instead of hardcoded premium. Beta users can now complete full generation flow including automatic quality improvements. Files: src/app/api/facilitator/lessons/request-changes/route.js (import resolveEffectiveTier/featuresForTier line 2, query subscription_tier lines 13-35, resolve tier line 36, check facilitatorTools lines 91-98), src/app/api/lesson-file/route.js (added logging for loaded lesson details).
2025-12-09T23:58:00Z | Copilot | FIX: Edit This Lesson button failing to load generated lessons with "Failed to load lesson" error. Root cause: lesson-maker page stored just the filename (e.g., "3rd_Fractions_intermediate.json") in generatedLessonKey, but lesson editor expects key format "subject/filename". The /api/lesson-file route requires "generated/filename" format to know to load from Supabase storage instead of filesystem. Solution: Changed setGeneratedLessonKey to store "generated/${generatedFile}" instead of just generatedFile. Edit button now correctly navigates to /facilitator/lessons/edit?key=generated/filename and lesson loads successfully. Files: src/app/facilitator/generator/lesson-maker/page.js (line 246-247, prepend "generated/" to filename).
2025-12-09T23:55:00Z | Copilot | FIX: Beta users blocked from generating lessons due to missing tier resolution in generate API. The /api/facilitator/lessons/generate route only queried plan_tier (not subscription_tier) and had hardcoded check for plan_tier !== 'premium', blocking Beta users who have subscription_tier='Beta' but no plan_tier set. Beta users should get Plus-level access including facilitatorTools. Solution: (1) Import resolveEffectiveTier and featuresForTier from entitlements. (2) Query both subscription_tier and plan_tier in readUserAndTier. (3) Call resolveEffectiveTier to map Beta→'plus'. (4) Replace hardcoded premium check with features.facilitatorTools check (available on Plus and above). Beta users now pass facilitatorTools check and can generate lessons. Files: src/app/api/facilitator/lessons/generate/route.js (import resolveEffectiveTier/featuresForTier line 2, query subscription_tier line 17-31, resolve effective tier line 34, check facilitatorTools instead of hardcoded premium line 163-166).
2025-12-09T23:50:00Z | Copilot | FEATURE: Edit This Lesson button in lesson generator appears after successful generation. After lesson is created, "Edit This Lesson" button appears next to "Generate Lesson" button, navigating directly to /facilitator/lessons/edit?key={lessonKey}. Button hidden until generation completes, then stored lesson key enables immediate editing. Provides instant access to edit newly generated lesson without navigating to lessons list first. Files: src/app/facilitator/generator/lesson-maker/page.js (added generatedLessonKey state, set after successful generation, conditional render button with router.push to edit page).
2025-12-09T23:45:00Z | Copilot | FIX: Beta users unable to generate lessons - client-side tier resolution missing. Client components (ClientGenerator, useAccessControl, lessons page, learners pages, calendar) were only querying plan_tier from database, not subscription_tier. This meant Beta users were treated as 'free' tier on client side even though API routes correctly mapped Beta→Plus. Solution: Import resolveEffectiveTier in all client components, query both subscription_tier and plan_tier, call resolveEffectiveTier to get effective tier. Beta users now properly get Plus-level access (5 lifetime + 1 weekly generation, facilitator tools, unlimited lessons). Files: src/app/facilitator/generator/ClientGenerator.jsx (query subscription_tier, use resolveEffectiveTier), src/app/hooks/useAccessControl.js (import resolveEffectiveTier, query subscription_tier, resolve tier), src/app/facilitator/lessons/page.js (import resolveEffectiveTier, query subscription_tier), src/app/facilitator/learners/page.js (import resolveEffectiveTier, query subscription_tier), src/app/facilitator/learners/add/page.js (import resolveEffectiveTier, query subscription_tier), src/app/facilitator/calendar/page.js (import resolveEffectiveTier, query subscription_tier).
2025-12-09T23:30:00Z | Copilot | SECURITY FIX: Generated lessons were leaking across facilitator accounts via metadata API. The /api/lessons/metadata route was searching ALL facilitator folders (facilitator-lessons/*) to find lessons by filename, meaning if two facilitators had lessons with the same filename, they could see each other's lessons. This violated data isolation between facilitators. Solution: Added authentication requirement to metadata API and changed logic to only load generated lessons (subject='generated') from the authenticated user's folder (facilitator-lessons/{userId}/). Public lessons from filesystem remain accessible to all. Files: src/app/api/lessons/metadata/route.js (added auth header parsing, only search authenticated user's folder for generated lessons, skip generated lessons if not authenticated).
2025-12-09T23:00:00Z | Copilot | FEATURE: Beta subscription tier now automatically grants Plus-level access. Users with subscription_tier='Beta' get Plus entitlements (unlimited lessons, facilitator tools, 5 lifetime generations + 1 weekly, 2 learners max) without requiring stripe_subscription_tier or plan_tier to be set. Added resolveEffectiveTier(subscriptionTier, paidTier) helper to entitlements.js that maps Beta→'plus' before lookup. Updated all usage check API routes to query both subscription_tier and paid tier fields, then call resolveEffectiveTier to determine effective access level. Beta remains independent from paid tiers (can change Beta entitlements without affecting Plus subscribers). Files: src/app/lib/entitlements.js (added resolveEffectiveTier function), src/app/api/usage/check-lesson-quota/route.js (query subscription_tier, use resolveEffectiveTier), src/app/api/usage/check-generation-quota/route.js (query subscription_tier, use resolveEffectiveTier), src/app/api/usage/increment-generation/route.js (query subscription_tier, use resolveEffectiveTier), src/app/api/lessons/quota/route.js (import resolveEffectiveTier, query subscription_tier in readPlanTierAndCountInTz).
2025-12-09T22:15:00Z | Copilot | FIX: Learner localStorage persistence across facilitator logout causing "Hi, [wrong learner]!" greeting. When facilitator logs out and different facilitator logs in on same device, /learn page displayed previous facilitator's learner name because learner_id/learner_name/learner_grade/learner_humor_level persisted in localStorage. Logout only cleared Supabase auth tokens, not learner data. Solution: (1) Added comprehensive learner localStorage cleanup to logout handler in account page - clears learner_id, learner_name, learner_grade, learner_humor_level, all pattern-matched keys (learner_humor_level_*, target_comprehension_*, target_exercise_*, target_worksheet_*, target_test_*, atomic_snapshot:*), global target overrides. (2) Added same cleanup to account deletion flow in settings page. (3) Added auth validation to /learn page useEffect - calls getLearner() to verify learner belongs to current facilitator, clears localStorage if not authenticated or ownership fails, prevents stale learner display. Snapshots (atomic_snapshot:*) also cleared to prevent cross-learner session restoration. Files: src/app/facilitator/account/page.js (logout handler lines 452-475, added localStorage cleanup), src/app/facilitator/account/settings/page.js (delete account handler lines 275-300, added localStorage cleanup), src/app/learn/page.js (useEffect lines 1-61, added getLearner import, auth validation with session check, ownership verification, stale data cleanup).
2025-12-09T22:00:00Z | Copilot | FIX: Clear opening action sequences when 30-second countdown starts to prevent hangover at work transition. When play timer expires and countdown overlay appears, any active opening action (ask, joke, riddle, poem, story, fill-in-fun, games) was persisting and could interfere with automatic transition to work subphase (teaching or Q&A) after countdown completes. Solution: Added comprehensive state clearing to handlePlayTimeUp callback - resets all opening action states to 'inactive' (askState, riddleState, poemState, storyState, fillInFunState), hides opening action buttons (setShowOpeningActions(false)), clears story data (transcript, setup step, characters, setting, plot), clears fill-in-fun data (template, collected words, current index), closes games overlay. This ensures clean slate before work phase auto-starts. Files: src/app/session/page.js (lines 813-838 in handlePlayTimeUp), docs/brain/timer-system.md (updated Play Time Expiration Flow section with clearing logic, added Recent Changes entry, updated last_updated timestamp), docs/brain/manifest.json (added 'opening action clearing' to timer-system keywords, updated timestamp).
2025-12-09T21:00:00Z | Copilot | CRITICAL AUTH FIX (ACTUAL ROOT CAUSE): Cross-device logout issue was NOT about localStorage or tabs - it was Supabase signOut() default scope. supabase.auth.signOut() defaults to scope: 'global', which invalidates the session SERVER-SIDE in Supabase database, logging out ALL devices sharing that account. Solution: Changed all signOut() calls to use scope: 'local', which only clears localStorage on current device without invalidating server session. Other devices stay logged in. Reverted unnecessary custom storage adapter and per-user client code from previous attempts. Root cause: Supabase sessions have two layers - client-side localStorage (device-local) + server-side session record (shared). Global scope invalidates shared record, affecting all devices. Local scope only clears device localStorage. Files: src/app/facilitator/account/settings/page.js (added scope: 'local' to delete account signOut), src/app/facilitator/account/page.js (added scope: 'local' to logout button), src/app/lib/supabaseClient.js (reverted to simple singleton client), docs/brain/auth-session-isolation.md (completely rewritten explaining scope issue, when to use local vs global, security trade-offs).

2025-12-09T20:30:00Z | Copilot | CRITICAL AUTH FIX v2: Per-user storage isolation instead of per-tab. Previous fix required re-login on every refresh (unacceptable UX). New approach: each USER gets isolated storage namespace, but same user shares auth across all tabs. Custom storage adapter implements Supabase Storage interface, stores auth at supabase-auth-user-<userId> keys. Client instances cached per userId (not singleton). Same user in multiple tabs shares client and auth (stay logged in together). Different users in different tabs use separate storage keys (isolated). Page refresh auto-detects user ID from localStorage, restores correct client (no re-login). Logout propagates to all tabs for that user but not to tabs with different users. Handles legacy migration from default storage key. Files: src/app/lib/supabaseClient.js (custom UserIsolatedStorage class, clientsByUserId Map, user ID auto-detection), docs/brain/auth-session-isolation.md (completely rewritten with per-user architecture). [REVERTED - see 2025-12-09T21:00:00Z]
2025-12-09T20:00:00Z | Copilot | CRITICAL AUTH FIX: Cross-tab auth leakage - logging out in one tab logged out ALL tabs, logging into new account in Tab A switched Tab B to that account. Root cause: Supabase client used default shared localStorage key 'sb-<project>-auth-token' for all tabs. Auth state changes in one tab immediately affected all other tabs via shared localStorage. Solution: Added per-tab unique storageKey using sessionStorage-persisted UUID (supabase-auth-<UUID>). Each tab generates unique storage key on first load, isolating auth sessions. Tab A logout/login no longer affects Tab B. Auth persists within tab across page navigation but refreshing tab generates new UUID (requires re-login, acceptable trade-off vs auth leakage). Created getTabStorageKey() function, added storageKey config to Supabase client. Created docs/brain/auth-session-isolation.md (per-tab storage keys, sessionStorage UUID, localStorage namespace isolation, migration path, edge cases). Updated manifest.json with auth-session-isolation entry. Files: src/app/lib/supabaseClient.js (added getTabStorageKey function lines 5-17, added storageKey config line 34), docs/brain/auth-session-isolation.md (NEW), docs/brain/manifest.json (added auth-session-isolation entry). [REVERTED - see 2025-12-09T20:30:00Z]
2025-12-09T19:00:00Z | Copilot | Created mr-mentor-session-persistence.md brain file; replaced 8s polling with Supabase realtime subscriptions on mentor_sessions.is_active for instant conflict detection; added atomic gate preventing stale conversation overwrites using last_local_update_at timestamp comparison; implemented turn limits (warn @30, force ClipboardOverlay @50 with disabled Cancel); added last_local_update_at column to mentor_sessions schema; removed duplicate draft_summary storage (single source in conversation_drafts); fixed zombie session cleanup on New Conversation; updated manifest.json with new brain entry
2025-12-09T15:00:00Z | Copilot | FIX: Email confirmation links not working after Supabase signup. Root cause: Missing redirect URL configuration and callback route. Added NEXT_PUBLIC_SITE_URL=https://mssonoma.com to .env.local. Created src/app/auth/callback/route.js to handle email confirmation by exchanging code for session and redirecting to /facilitator. Updated signup/login pages to construct emailRedirectTo as {NEXT_PUBLIC_SITE_URL}/auth/callback. USER MUST: (1) Add NEXT_PUBLIC_SITE_URL=https://mssonoma.com to Vercel environment variables (Project Settings → Environment Variables, apply to all environments). (2) Configure Supabase dashboard to whitelist redirect URL: go to https://app.supabase.com/project/fyfepvozqxgldgfpznrr/auth/url-configuration and add https://mssonoma.com/auth/callback to Redirect URLs list. (3) Redeploy to apply changes. Created docs/AUTH_EMAIL_LINK_FIX.md with setup instructions and troubleshooting. Files: .env.local (added NEXT_PUBLIC_SITE_URL), src/app/auth/callback/route.js (new), src/app/auth/signup/page.js (updated emailRedirectTo), src/app/auth/login/page.js (updated resend emailRedirectTo).
2025-12-09T14:00:00Z | Copilot | FIX: Visual aids broken images due to expired DALL-E URLs being saved to database. Root cause: When download failed, code fell back to original expired URL and saved it. Now implements retry logic with exponential backoff (3 attempts: 1s, 2s, 4s delays) for both fetch and Supabase upload operations. Retries handle: network timeouts, HTTP 403/404 (expired URLs), HTTP 429 (rate limits), HTTP 5xx errors. Non-retryable errors (400/401, invalid URLs) fail immediately. Images that fail all retries are filtered out (return null) instead of saving expired URLs. Added maxDuration=25 on save route for Vercel timeout protection. Detailed logging tracks attempt numbers, error types, success/failure counts. Updated visual-aids.md brain file with retry logic section and expanded "What NOT To Do" with never-save-expired-URLs rules. Files: src/app/api/visual-aids/lib/downloadImage.js (added retry wrapper, isRetryable, sleep helpers), src/app/api/visual-aids/save/route.js (maxDuration, null filtering, improved logging), docs/brain/visual-aids.md (retry documentation).
2025-12-09T10:00:00Z | Copilot | FIX: Visual aids generation timing out after 30 seconds on Vercel. Root cause: sequential for-loop made 3 API calls per image (prompt generation, description generation, DALL-E), then repeated for count images. With 3 images this meant 9 sequential OpenAI calls taking 40+ seconds. Converted to parallel execution: (1) Generate all images in parallel using Promise.all. (2) Within each image, parallelize description and DALL-E generation after getting prompt. Now all images generate simultaneously, completing well under 30 seconds. Files: src/app/api/visual-aids/generate/route.js (replaced sequential for-loop with generateSingleImage helper + Promise.all).
2025-12-09T07:00:00Z | Copilot | SECURITY FIX: Set explicit search_path on 9 database functions to prevent search path injection attacks. Functions with mutable search_path allow attackers to potentially hijack function behavior by manipulating the schema search order. Added SET search_path to: transcripts_owner_id_from_path, update_visual_aids_updated_at, sync_learners_targets, deactivate_old_mentor_sessions, set_learners_owner_id (includes auth schema), update_lesson_schedule_timestamp, deactivate_old_lesson_sessions, archive_conversation_update, maybe_archive_long_conversation. All SECURITY DEFINER functions now have explicit search_path to prevent privilege escalation. Files: supabase/migrations/20251209010000_fix_function_search_path.sql.
2025-12-09T06:00:00Z | Copilot | SECURITY FIX: Removed SECURITY DEFINER from session_metrics view to enforce RLS. View was running with owner privileges, bypassing Row Level Security and potentially exposing session data across facilitator boundaries. Created migration 20251209000000_fix_session_metrics_security_definer.sql that drops and recreates view without SECURITY DEFINER. View now properly inherits RLS from underlying lesson_sessions table, ensuring facilitators only see their own learner data. Files: supabase/migrations/20251209000000_fix_session_metrics_security_definer.sql.
2025-12-09T00:45:00Z | Copilot | FEATURE: Added TTS prefetch to teaching flow sentence-by-sentence delivery. Teaching phase delivers definitions and examples as multiple sentences (split after GPT call returns full content). Each sentence now prefetches the next one while student reads/processes current sentence. Prefetch triggers added: (1) After first vocab sentence (line 312), prefetch sentence 2. (2) After each subsequent vocab sentence (line 550), prefetch next vocab sentence. (3) After first example sentence (line 436), prefetch sentence 2. (4) After each subsequent example sentence (line 607), prefetch next example sentence. Pattern matches Q&A phases: speak current → prefetch next → gate buttons → student clicks Next → instant playback from cache. Teaching sentences now load instantly after first sentence (2-15 sentences per stage depending on vocab count). Files: src/app/session/hooks/useTeachingFlow.js (import ttsCache line 10, prefetch after sentences lines 312-314, 436-438, 550-552, 607-609). Updated docs/brain/tts-prefetching.md with teaching flow section.
2025-12-09T00:30:00Z | Copilot | FEATURE: Completed TTS prefetch coverage for worksheet and test phases. Added prefetch triggers at lines 6264-6277 (worksheet) and 6383-6391 (test) in page.js. After speaking current question, now prefetch next question OR transition line (worksheet closing "That's all for the worksheet. Now let's begin the test." when last question answered). Worksheet and test now match comprehension/exercise pattern: Q1 instant (awaiting-begin prefetch), Q2+ instant (cache hit from post-answer prefetch). Updated docs/brain/tts-prefetching.md with worksheet/test integration sections showing exact trigger placement. TTS prefetch now complete for all Q&A phases (comprehension, exercise, worksheet, test) - only opening elements and GPT teaching content remain unprefetched.
2025-12-09T00:00:00Z | Copilot | FEATURE: TTS prefetching system to eliminate waiting between questions. Created ttsCache.js module with LRU cache (max 10 items, oldest eviction), AbortController for canceling pending fetches, and prefetch() method for fire-and-forget background loading. Integrated into speakFrontendImpl: checks cache before fetch, stores successful responses. Added prefetch triggers: (1) After speaking comprehension question, prefetch next question from generatedComprehension array. (2) After speaking exercise question, prefetch next question from generatedExercise array. (3) When starting comprehension/exercise phases, prefetch second question while first plays. (4) Cache clears on phase transitions via useEffect to prevent stale audio. Performance impact: Questions 2+ now load instantly (cache hit), eliminating 2-3 second TTS waits that were main app bottleneck. Cache size limited to 10 to prevent memory issues during long sessions. Silent failures on prefetch errors ensure non-critical optimization never breaks core flow. Files: src/app/session/utils/ttsCache.js (new 212-line module), src/app/session/page.js (import line 31, cache check in speakFrontendImpl lines 2927-2962, prefetch after comprehension answer lines 5895-5903, prefetch after exercise answer lines 6063-6071, cache clear effect line 990), src/app/session/hooks/usePhaseHandlers.js (import line 13, prefetch after first comprehension question lines 105-111, prefetch after first exercise question lines 163-169).
2025-12-08T23:15:00Z | Copilot | FIX: Opening actions buttons incorrectly reappearing after Ask Q&A during exercise/comprehension/worksheet/test phases. Root cause: handleAskConfirmYes and handleAskBack in useDiscussionHandlers were calling setShowOpeningActions(true) when in Q&A phases. Opening actions (Ask/Joke/Riddle/Poem/Story/Fill-in-Fun/Games/Go) should ONLY show during entrance state (before Go button is clicked), NEVER during active Q&A phases. The bug caused these buttons to reappear after exiting Ask mode during active Q&A. This is a recurring issue - see changelog entries 2025-12-02T20:00:00Z and 2025-12-02T20:15:00Z for previous attempts to fix related button visibility bugs. Solution: Changed handleAskConfirmYes and handleAskBack to only show opening actions in discussion awaiting-learner phase, explicitly setting showOpeningActions(false) for all Q&A phases regardless of subPhase. Files: src/app/session/hooks/useDiscussionHandlers.js (lines 221-232 and 269-280 removed inQnAPhase logic, now only show buttons in discussion phase).
2025-12-08T22:45:00Z | Copilot | FIX: Snapshot restoration also needs target size validation. Previous fix updated page.js to validate stored arrays match COMPREHENSION_TARGET/EXERCISE_TARGET, but snapshot restoration in useSnapshotPersistence.js still used old length > 0 check. This created race where: (1) Fresh arrays generated with size 5. (2) page.js validation rejected cached size-3 arrays. (3) Fresh size-5 arrays set. (4) THEN snapshot hook restored cached size-3 arrays, overwriting fresh. Flow was: page.js generates correct arrays, then snapshot restoration immediately overwrites them with wrong-size cached arrays. Solution: Pass comprehensionTarget and exerciseTarget parameters to useSnapshotPersistence hook. Changed restoration validation from `length > 0` to `length === comprehensionTarget` and `length === exerciseTarget`. Now cached arrays are only restored if they match CURRENT target sizes. When learner changes targets, cached arrays are invalidated automatically. Files: src/app/session/hooks/useSnapshotPersistence.js (added comprehensionTarget/exerciseTarget params line 84-85, changed validation lines 502-503), src/app/session/page.js (passed COMPREHENSION_TARGET and EXERCISE_TARGET to hook line 3414-3415).
2025-12-08T22:30:00Z | Copilot | FIX: Cached arrays with wrong size restored when learner targets changed. Arrays were generated correctly (size 5 for COMPREHENSION_TARGET=5) but then OLD cached arrays (size 3) were restored from storage, overwriting fresh generation. Console showed: "[ARRAY GEN] Generated arrays - comprehension: 5" then "[handleGoComprehension] generatedComprehension: Array(3) length: 3". Root cause: Validation only checked arrays were non-empty (length > 0), not that they matched CURRENT target sizes. When learner changed from 3 to 5 questions, old 3-question arrays passed validation and got restored. Solution: Changed compOk and exOk validation to require exact size match (length === COMPREHENSION_TARGET and length === EXERCISE_TARGET). Now when targets change, cached arrays are invalidated and fresh arrays generate with correct size. Added diagnostic logging showing target values during generation. Files: src/app/session/page.js (lines 1852-1853 validation, line 1892 logging).
2025-12-08T22:00:00Z | Copilot | FIX: Next question not asked after celebration. After correct answer, Ms. Sonoma said "Good work! That makes 1 correct answer" but didn't ask the next question - just stopped and waited for input. Root cause: Previous fix cleared currentCompProblem and enabled input (setCanSend(true)) expecting user to trigger next question load, but celebration and next question must be spoken in SAME response without user input in between. Solution: After incrementing ticker, immediately load next question from array and speak "Celebration. Progress. Next question" all together in one speakFrontend call. Added nextProblem loading logic after ticker increment in both comprehension and exercise phases. Files: src/app/session/page.js (comprehension and exercise correct answer handling).
2025-12-08T21:30:00Z | Copilot | FIX: Double-increment bug causing Q&A to stop at 2 questions when target=5. Root cause: Pre-picking nextProblem logic incremented currentCompIndex/currentExIndex BEFORE actually asking the question, consuming 2 array slots per question. Flow was: (1) Answer Q1 correctly, pre-pick generatedComprehension[0] as nextProblem, increment index to 1. (2) Speak "Correct! Here's Q2" and ask the pre-picked question. (3) Answer Q2 correctly, pre-pick generatedComprehension[1], increment to 2. (4) But we skipped actually using index 1 - it was consumed during pre-pick! With target=5 and array indices 0-4, after 2 correct answers currentIndex=2 but we only asked questions from slots 0 and 1, burning through array at 2x speed. Solution: Removed all nextProblem pre-picking logic in both comprehension and exercise phases. After correct answer, now clear currentCompProblem/currentExerciseProblem so next question naturally loads from array when handleSend runs again. Each question consumes exactly one array slot. Simplified correct answer flow: celebrate, save snapshot, clear problem, enable input. Files: src/app/session/page.js (removed 50 lines of pre-picking logic, removed defensive array-exhaustion checks which are now impossible).
2025-12-08T20:30:00Z | Copilot | ZOMBIE CLEANUP: Remove final pool references from hooks. Runtime error "ReferenceError: setCompPool is not defined" revealed that zombie pool references still existed in hook parameters and dependencies despite earlier removal of pool state. Removed compPool/exercisePool parameters from useAssessmentDownloads hook definition (line 23-24). Removed compPool/exercisePool from usePhaseHandlers call in page.js (lines 3050, 3053, 3060, 3064). Changed all saveAssessments calls to use empty arrays instead of non-existent pools (useAssessmentDownloads lines 166-167, 212-213, 823-824; page.js line 4738). Removed pool dependencies from all useCallback dependency arrays. All pool references now eliminated from codebase (only explanatory comments remain). Build passes, no more setCompPool errors. Files: src/app/session/hooks/useAssessmentDownloads.js (removed pool params and references), src/app/session/page.js (removed pool params passed to hooks and saveAssessments calls).
