2025-12-02T00:30:00Z | Copilot | MR. MENTOR CONVERSATION PERSISTENCE FIX: Restored loading active conversations from database. Sessions now work correctly: load most recent active conversation if exists, start fresh if no active session. When conversation is saved/deleted, session is deactivated (is_active=false) and next session starts fresh. Previous fix incorrectly always started with empty conversation - now only starts empty when no active session exists. Files: src/app/facilitator/generator/counselor/CounselorClient.jsx (lines 514, 538 restored conversation_history loads with clarifying comments).
2025-12-02T00:15:00Z | Copilot | [REVERTED] MR. MENTOR CONVERSATION HISTORY FIX (COMPLETE): Sessions now start with empty conversation history instead of loading stale database data. Previous fix stopped polling overwrite but missed session initialization loading old conversation. Database had immortalized "skip button" conversation which loaded every session start. Now sessions always begin fresh with empty array - only load conversation during explicit takeover. Files: src/app/facilitator/generator/counselor/CounselorClient.jsx (lines 514, 538 session init, removed conversation_history loads).
2025-12-02T00:00:00Z | Copilot | MR. MENTOR CONVERSATION HISTORY FIX: Session polling was overwriting live conversation history with stale database data every 8 seconds. This caused recall flow to always show the same old conversation (skip button discussion) instead of current conversation. Removed conversationHistory load from conflict detection polling - now only loads during session takeover, not during normal active polling. Files: src/app/facilitator/generator/counselor/CounselorClient.jsx (line 426 polling handler, removed stale conversation_history overwrite).
2025-12-01T19:30:00Z | Copilot | CACHED ASSESSMENT VALIDATION FIX: Added lesson content verification before restoring cached worksheets/tests. System was loading European exploration questions for Fractions lesson because storage key didn't validate content match. Now checks if first cached worksheet question exists in current lesson's question pool - if not found, treats as content mismatch and regenerates fresh. Prevents wrong-lesson question bleed across lessons with similar filenames. Files: src/app/session/page.js (lines 1793-1828, added lessonContentMismatch detection comparing stored worksheet[0] against all current lesson questions).
2025-11-25T22:29:00Z | Copilot | COPILOT INSTRUCTIONS RESTRUCTURE: Extracted monolithic copilot-instructions.md into brain files. Created docs/brain/ms-sonoma-teaching-system.md (teaching flow, phases, content safety, leniency modes, brand signals, VERBATIM cues, normalization, slot policy, turn map) and docs/brain/beta-program.md (tutorial gating, survey unlock, event instrumentation, feature flags). Kept BRAIN FILE PROTOCOL, PRE-FLIGHT CHECKLIST, and CRITICAL GUARDRAILS in .github/copilot-instructions.md. Archived old version to .github/instructions/copilot-instructions.20251125-222923Z.md. Updated manifest.json with 2 new entries (13 keywords for teaching system, 12 for beta program). Files: docs/brain/ms-sonoma-teaching-system.md (NEW, canonical teaching protocol), docs/brain/beta-program.md (NEW, Beta tier gating and analytics), .github/copilot-instructions.md (reduced from 459 to ~240 lines), docs/brain/manifest.json (added ms-sonoma-teaching-system and beta-program entries).
2025-01-20T04:30:00Z | Copilot | Updated snapshot-persistence.md: Added first-interaction gate to prevent infinite play timer hack. New gate fires once per session when user clicks any opening button (Ask, Joke, Riddle, Poem, Story, Fill-in-Fun, Games, Go) except Begin. Persists timer state on first interaction so refresh can't reset play timer. Implementation: added hasRecordedFirstInteraction state flag, recordFirstInteraction() wrapper function, wrapped all opening button onClick handlers in both discussion phase and Q&A phase. Files: src/app/session/page.js (lines 498-499 state, 541-548 helper, 7173-7181 discussion buttons, 7233-7241 Q&A buttons), docs/brain/snapshot-persistence.md (added first-interaction section), docs/brain/manifest.json (updated timestamp, added first-interaction gate to keywords).
2025-11-25T19:45:00Z | Copilot | Created visual-aids.md: Documents DALL-E 3 generation flow with critical no-text constraint enforcement, prompt engineering layers, storage pipeline, carousel UI, and rewrite-text integration. Added to manifest.json with 7 systems keywords.
2025-11-25T19:45:00Z | Copilot | AGENTS.MD BRAIN ENFORCEMENT: Added mandatory post-code-change brain check requirement to AGENTS.md. New section "Brain File Enforcement (MANDATORY after code changes)" requires BrainMaker to IMMEDIATELY check manifest.json after ANY code changes and either ask about updating existing brain file or ask about creating new one. Added detection rule: "If you complete code changes and your response doesn't mention brain documentation, you FAILED this requirement." This closes the enforcement gap where BrainMaker could update copilot-instructions.md with brain protocol but still skip applying it. The check is now a mandatory artifact like changelog entries, not an optional courtesy. Files: AGENTS.md (lines 31-42).
2025-11-25T19:30:00Z | Copilot | BRAIN PROTOCOL CRITICAL FIX: Closed documentation loophole. Previous protocol said "ask if new file should be created" but didn't mandate it, allowing systems to go undocumented. New step 4 DOCUMENT: "ALWAYS check if system needs brain documentation" with explicit examples (APIs, flows, persistence, UI patterns, prompt engineering). Added guardrail: "NEVER skip asking about brain documentation when making core system changes". Added detection rule: "If you make code changes and don't mention brain documentation, you violated protocol". This prevents future situations where significant changes (like visual aids text removal fix) happen without brain file creation offers. Files: .github/copilot-instructions.md (lines 13-28, 46-54).
2025-11-25T19:00:00Z | Copilot | VISUAL AIDS TEXT REMOVAL FIX: Eliminated text/words in AI-generated visual aids. DALL-E was generating gibberish text in images because prompts used phrases like "visual aid", "diagram", "labels". Fixed: 1) /api/visual-aids/generate/route.js - rewrote system prompt to emphasize "scenes, objects, actions" not "diagrams"; added explicit no-text enforcement to DALL-E prompt ("must contain absolutely NO text, words, letters, numbers, labels, captions"). 2) /api/ai/rewrite-text/route.js - updated visual-aid-prompt-from-notes and generation-prompt purposes to warn that "AI-generated text in images is gibberish" and suggest "visual metaphors or real-world examples instead of diagrams with text". Result: images now show only visual elements (people, objects, nature, scenes) without any written language. Files: src/app/api/visual-aids/generate/route.js (lines 64-70, 127-128), src/app/api/ai/rewrite-text/route.js (lines 51-67, 70-84).
2025-11-24T05:00:00Z | Copilot | PLAY TIME EXPIRED GO BUTTON OVERRIDE: When "Time to Get Back to Work!" countdown overlay is showing, clicking the Go button now immediately dismisses the overlay and starts work timer, overriding the 30-second countdown. Previously countdown had to complete before Go button would work. Added setShowPlayTimeExpired(false) and setPlayExpiredPhase(null) calls to all phase start handlers (handleGoComprehension, handleGoExercise, handleGoWorksheet, handleGoTest, handleStartLesson). User request: "If the Time to Get Back to Work! overlay is up and the user selects Go and confirms, that overrides the countdown." Files: src/app/session/hooks/usePhaseHandlers.js (added overlay dismissal logic to 5 handlers, added 2 new parameters), src/app/session/page.js (passed setShowPlayTimeExpired and setPlayExpiredPhase to usePhaseHandlers).
2025-11-24T00:00:00Z | Copilot | CONTENT SAFETY IMPLEMENTATION: Added 7-layer defense system to protect against adversarial attacks on Ask/Poem/Story/Fill-in-the-Fun features. Created src/lib/contentSafety.js with validateInput (banned keywords, prompt injection detection, length limits), hardenInstructions (safety preamble), validateOutput (post-LLM validation), checkContentModeration (OpenAI Moderation API). Integrated into /api/sonoma/route.js: input validation before LLM, instruction hardening with safety rules, output validation after response. Added feature flags (ENABLE_POEM_FEATURE, ENABLE_STORY_FEATURE) for emergency kill switch. Created Supabase migration for safety_incidents logging table. Added test suite (scripts/test-content-safety.mjs) - all tests passing. Updated .github/copilot-instructions.md with CONTENT SAFETY RULES section. Files: src/lib/contentSafety.js (NEW, 413 lines), src/app/api/sonoma/route.js (modified), .env.local.example (NEW), supabase/migrations/add_safety_incidents_table.sql (NEW), scripts/test-content-safety.mjs (NEW).
2025-11-20T23:00:00Z | Copilot | SESSION TAKEOVER CANONICAL DOC: Created docs/brain/session-takeover.md with gate-based architecture. Replaces zombie polling approach. Conflict detection happens at atomic checkpoint gates (same gates as snapshot saves), no polling. Database schema: lesson_sessions gets session_id (UUID), device_name, last_activity_at; unique constraint + trigger enforce single active session per learner+lesson. PIN-validated takeover dialog (reuses existing component + auth). Timer state persisted in snapshot payload (elapsedSeconds + capturedAt), restore calculates drift for continuity. Cleanup: delete polling methods from useSessionTracking, remove line 4213 call. Beta analytics (session events, transcripts, notes) unaffected. Files: docs/brain/session-takeover.md (NEW), manifest.json updated.
2025-11-20T21:30:00Z | Copilot | SNAPSHOT PERSISTENCE CANONICAL DOC: Created docs/brain/snapshot-persistence.md with authoritative architecture. Snapshots use ATOMIC GATES at explicit checkpoints (after each teaching sentence, after each comprehension answer), NOT polling. localStorage+database hybrid: saves to both, restores from localStorage first (instant), database fallback (cross-device). Device switch: localStorage empty→database restore→write to localStorage. Session takeover is separate system (see session-takeover.md). Files: docs/brain/snapshot-persistence.md (NEW canonical reference).
2025-11-20T15:05:18Z | Copilot | [ZOMBIE - DISREGARD] Lesson session takeover polling - built incorrectly for learner lessons, disabled same day (page.js line 4213 commented), caused performance issues. Correct architecture: gate-based conflict detection (see session-takeover.md). NOTE: Mr. Mentor session takeover polling still works correctly (different system, mentor_sessions table).
2025-11-20T00:25:00Z | Copilot | CRITICAL BUG: TEACHING EXAMPLES MISSING VOCAB CONTEXT: Examples stage was always generating generic math examples regardless of lesson subject because vocab list was never loaded and instruction didn't mention the vocabulary words. Added vocab loading logic (same as definitions stage) and included vocab terms in instruction prompt. Changed API payload from vocab:[] to vocab:hasAnyVocab?vocabList:[]. Files: src/app/session/hooks/useTeachingFlow.js (teachExamples function lines ~335-390).
2025-11-20T00:20:00Z | Copilot | RESUME BUTTON SENTENCE REPLAY: Moved teaching sentence replay from automatic restore to Resume button click. Previously Ms. Sonoma auto-replayed last sentence immediately on refresh before Resume button was pressed. Now sentence only replays when user clicks Resume. Files: src/app/session/hooks/useSnapshotPersistence.js (removed auto-replay on restore), src/app/session/hooks/useResumeRestart.js (added replay logic to handleResumeClick), src/app/session/page.js (pass getTeachingFlowSnapshot to useResumeRestart).
2025-11-20T00:15:00Z | Copilot | DEBUG LOG CLEANUP: Removed all ATOMIC SNAPSHOT, TEACHING FLOW, and BUTTON DEBUG console.log statements. Snapshot persistence now runs silently except for error logs. Files: src/app/session/page.js, src/app/session/hooks/useSnapshotPersistence.js, src/app/session/hooks/useTeachingFlow.js.
2025-11-20T00:10:00Z | Copilot | NEXT SENTENCE LOADING UX: Added loading overlay during teaching sentence advancement. The 1-2 second database save delay before TTS starts felt unresponsive. Now shows loading state from click until TTS begins. Files: src/app/session/hooks/useTeachingFlow.js (setTtsLoadingCount increment/decrement around scheduleSaveSnapshot calls for vocab and example sentences).
2025-11-20T00:05:00Z | Copilot | SKIP BUTTON SNAPSHOT RACE FIX: Teaching sentence saves were happening AFTER TTS finished, so clicking skip lost progress. Moved all sentence saves to BEFORE speakFrontend calls so state checkpoints immediately when advancing. Fixes refresh loading old state when user skips through sentences. Files: src/app/session/hooks/useTeachingFlow.js (vocab-sentence-1, vocab-sentence-N, example-sentence-1, example-sentence-N saves now precede TTS).
2025-11-19T17:35:00Z | Copilot | REACT ASYNC STATE TIMING BUG FIX: Comprehension-active save was capturing comprehension-start state due to React async setState. Removed redundant begin-comprehension save, wrapped comprehension-active save in setTimeout(() => {}, 0) to ensure state flushes before snapshot capture. Closes infinite playtime exploit (refresh before Go button restored to teaching phase). Files: src/app/session/page.js (beginComprehensionPhase function lines ~4593-4605).
2025-11-19T17:20:00Z | Copilot | CRITICAL SNAPSHOT SAVE BUG FIX: saveSnapshot was not checking fetch response, causing silent failures. Database saves were failing but console showed "Save SUCCESS" anyway. Added response.ok check and error logging to reveal actual database errors. This was causing comprehension phase saves to fail silently while teaching saves succeeded. Files: src/app/session/sessionSnapshotStore.js (added response checking, error logging lines 265-274).
2025-11-19T15:15:00Z | Copilot | TEACHING EXAMPLES GATE FIX: Removed premature promptGateRepeat call after first example sentence. The "Do you have any questions?" gate was appearing twice: once after the first example sentence (incorrect) and once after all example sentences (correct). Now only shows the gate after all examples are complete. Files: src/app/session/hooks/useTeachingFlow.js (removed line 507 early gate call, kept line 546 final gate call).
2025-11-19T14:45:00Z | Copilot | SNAPSHOT VERSION GATE: Added snapshotVersion=2 marker to all new atomic snapshots. Restore now skips old v1 snapshots from before atomic redesign to prevent zombie snapshots with old signature/reconciliation logic from resurrecting. Old snapshots are ignored and session starts fresh, forcing first atomic checkpoint save. Fixes issue where refreshing kept restoring to pre-atomic snapshot despite new saves succeeding. Files: src/app/session/hooks/useSnapshotPersistence.js (version marker in payload, version check in restore).
2025-11-19T14:30:00Z | Copilot | ATOMIC SNAPSHOT REDESIGN: Completely removed signature-based autosave, reconciliation effects, and drift correction. Snapshots now save explicitly at checkpoints only: after each teaching sentence spoken (vocab/examples), after each Q&A question answered (comprehension/exercise/worksheet/test). Restore applies saved state exactly with no post-restore modifications. Deleted: snapshotSigMemo, autosave effects (ticker/state-change), resume reconciliation effect, 2-second post-restore guard. Simplified scheduleSaveSnapshot to direct save without debounce/signature/retry logic. Goal: eliminate Frankenstein complexity, stop restored state from drifting. Files: src/app/session/hooks/useSnapshotPersistence.js (removed ~200 lines reconciliation logic), src/app/session/hooks/useTeachingFlow.js (added explicit save calls after sentences), src/app/session/page.js (added explicit save calls after questions, removed snapshotSigMemo destructuring). RISK: Timer persistence 90% chance of breaking per user warning, will require separate debug day.
2025-11-19T01:30:00Z | Copilot | CRITICAL REVERT: Restored original lessonData.id requirement for snapshot restore. Previous "any stable key" change (lines 457-460) caused restore to run too early before lessonData loaded, find no snapshots, mark as restored, then never retry when lessonData finally arrived. Resume/Restart buttons disappeared because snapshots existed but were never found. Files: src/app/session/hooks/useSnapshotPersistence.js.
2025-11-19T01:15:00Z | Copilot | SNAPSHOT AUTOSAVE UNBLOCK: When keys.length===0, now marks restoredSnapshotRef=true immediately so autosaves can begin instead of infinite postponement. Files: src/app/session/hooks/useSnapshotPersistence.js.
2025-11-19T00:50:00Z | Copilot | SNAPSHOT RESTORE SIMPLIFY: Removed sourcesReady postpone logic that was blocking restore completion—now always finalizes restore attempt and marks as restored so autosaves can start. Files: src/app/session/hooks/useSnapshotPersistence.js.
