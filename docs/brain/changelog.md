2025-11-24T05:00:00Z | Copilot | PLAY TIME EXPIRED GO BUTTON OVERRIDE: When "Time to Get Back to Work!" countdown overlay is showing, clicking the Go button now immediately dismisses the overlay and starts work timer, overriding the 30-second countdown. Previously countdown had to complete before Go button would work. Added setShowPlayTimeExpired(false) and setPlayExpiredPhase(null) calls to all phase start handlers (handleGoComprehension, handleGoExercise, handleGoWorksheet, handleGoTest, handleStartLesson). User request: "If the Time to Get Back to Work! overlay is up and the user selects Go and confirms, that overrides the countdown." Files: src/app/session/hooks/usePhaseHandlers.js (added overlay dismissal logic to 5 handlers, added 2 new parameters), src/app/session/page.js (passed setShowPlayTimeExpired and setPlayExpiredPhase to usePhaseHandlers).
2025-11-24T00:00:00Z | Copilot | CONTENT SAFETY IMPLEMENTATION: Added 7-layer defense system to protect against adversarial attacks on Ask/Poem/Story/Fill-in-the-Fun features. Created src/lib/contentSafety.js with validateInput (banned keywords, prompt injection detection, length limits), hardenInstructions (safety preamble), validateOutput (post-LLM validation), checkContentModeration (OpenAI Moderation API). Integrated into /api/sonoma/route.js: input validation before LLM, instruction hardening with safety rules, output validation after response. Added feature flags (ENABLE_POEM_FEATURE, ENABLE_STORY_FEATURE) for emergency kill switch. Created Supabase migration for safety_incidents logging table. Added test suite (scripts/test-content-safety.mjs) - all tests passing. Updated .github/copilot-instructions.md with CONTENT SAFETY RULES section. Files: src/lib/contentSafety.js (NEW, 413 lines), src/app/api/sonoma/route.js (modified), .env.local.example (NEW), supabase/migrations/add_safety_incidents_table.sql (NEW), scripts/test-content-safety.mjs (NEW).
2025-11-20T23:00:00Z | Copilot | SESSION TAKEOVER CANONICAL DOC: Created docs/brain/session-takeover.md with gate-based architecture. Replaces zombie polling approach. Conflict detection happens at atomic checkpoint gates (same gates as snapshot saves), no polling. Database schema: lesson_sessions gets session_id (UUID), device_name, last_activity_at; unique constraint + trigger enforce single active session per learner+lesson. PIN-validated takeover dialog (reuses existing component + auth). Timer state persisted in snapshot payload (elapsedSeconds + capturedAt), restore calculates drift for continuity. Cleanup: delete polling methods from useSessionTracking, remove line 4213 call. Beta analytics (session events, transcripts, notes) unaffected. Files: docs/brain/session-takeover.md (NEW), manifest.json updated.
2025-11-20T21:30:00Z | Copilot | SNAPSHOT PERSISTENCE CANONICAL DOC: Created docs/brain/snapshot-persistence.md with authoritative architecture. Snapshots use ATOMIC GATES at explicit checkpoints (after each teaching sentence, after each comprehension answer), NOT polling. localStorage+database hybrid: saves to both, restores from localStorage first (instant), database fallback (cross-device). Device switch: localStorage empty→database restore→write to localStorage. Session takeover is separate system (see session-takeover.md). Files: docs/brain/snapshot-persistence.md (NEW canonical reference).
2025-11-20T15:05:18Z | Copilot | [ZOMBIE - DISREGARD] Lesson session takeover polling - built incorrectly for learner lessons, disabled same day (page.js line 4213 commented), caused performance issues. Correct architecture: gate-based conflict detection (see session-takeover.md). NOTE: Mr. Mentor session takeover polling still works correctly (different system, mentor_sessions table).
2025-11-20T00:25:00Z | Copilot | CRITICAL BUG: TEACHING EXAMPLES MISSING VOCAB CONTEXT: Examples stage was always generating generic math examples regardless of lesson subject because vocab list was never loaded and instruction didn't mention the vocabulary words. Added vocab loading logic (same as definitions stage) and included vocab terms in instruction prompt. Changed API payload from vocab:[] to vocab:hasAnyVocab?vocabList:[]. Files: src/app/session/hooks/useTeachingFlow.js (teachExamples function lines ~335-390).
2025-11-20T00:20:00Z | Copilot | RESUME BUTTON SENTENCE REPLAY: Moved teaching sentence replay from automatic restore to Resume button click. Previously Ms. Sonoma auto-replayed last sentence immediately on refresh before Resume button was pressed. Now sentence only replays when user clicks Resume. Files: src/app/session/hooks/useSnapshotPersistence.js (removed auto-replay on restore), src/app/session/hooks/useResumeRestart.js (added replay logic to handleResumeClick), src/app/session/page.js (pass getTeachingFlowSnapshot to useResumeRestart).
2025-11-20T00:15:00Z | Copilot | DEBUG LOG CLEANUP: Removed all ATOMIC SNAPSHOT, TEACHING FLOW, and BUTTON DEBUG console.log statements. Snapshot persistence now runs silently except for error logs. Files: src/app/session/page.js, src/app/session/hooks/useSnapshotPersistence.js, src/app/session/hooks/useTeachingFlow.js.
2025-11-20T00:10:00Z | Copilot | NEXT SENTENCE LOADING UX: Added loading overlay during teaching sentence advancement. The 1-2 second database save delay before TTS starts felt unresponsive. Now shows loading state from click until TTS begins. Files: src/app/session/hooks/useTeachingFlow.js (setTtsLoadingCount increment/decrement around scheduleSaveSnapshot calls for vocab and example sentences).
2025-11-20T00:05:00Z | Copilot | SKIP BUTTON SNAPSHOT RACE FIX: Teaching sentence saves were happening AFTER TTS finished, so clicking skip lost progress. Moved all sentence saves to BEFORE speakFrontend calls so state checkpoints immediately when advancing. Fixes refresh loading old state when user skips through sentences. Files: src/app/session/hooks/useTeachingFlow.js (vocab-sentence-1, vocab-sentence-N, example-sentence-1, example-sentence-N saves now precede TTS).
2025-11-19T17:35:00Z | Copilot | REACT ASYNC STATE TIMING BUG FIX: Comprehension-active save was capturing comprehension-start state due to React async setState. Removed redundant begin-comprehension save, wrapped comprehension-active save in setTimeout(() => {}, 0) to ensure state flushes before snapshot capture. Closes infinite playtime exploit (refresh before Go button restored to teaching phase). Files: src/app/session/page.js (beginComprehensionPhase function lines ~4593-4605).
2025-11-19T17:20:00Z | Copilot | CRITICAL SNAPSHOT SAVE BUG FIX: saveSnapshot was not checking fetch response, causing silent failures. Database saves were failing but console showed "Save SUCCESS" anyway. Added response.ok check and error logging to reveal actual database errors. This was causing comprehension phase saves to fail silently while teaching saves succeeded. Files: src/app/session/sessionSnapshotStore.js (added response checking, error logging lines 265-274).
2025-11-19T15:15:00Z | Copilot | TEACHING EXAMPLES GATE FIX: Removed premature promptGateRepeat call after first example sentence. The "Do you have any questions?" gate was appearing twice: once after the first example sentence (incorrect) and once after all example sentences (correct). Now only shows the gate after all examples are complete. Files: src/app/session/hooks/useTeachingFlow.js (removed line 507 early gate call, kept line 546 final gate call).
2025-11-19T14:45:00Z | Copilot | SNAPSHOT VERSION GATE: Added snapshotVersion=2 marker to all new atomic snapshots. Restore now skips old v1 snapshots from before atomic redesign to prevent zombie snapshots with old signature/reconciliation logic from resurrecting. Old snapshots are ignored and session starts fresh, forcing first atomic checkpoint save. Fixes issue where refreshing kept restoring to pre-atomic snapshot despite new saves succeeding. Files: src/app/session/hooks/useSnapshotPersistence.js (version marker in payload, version check in restore).
2025-11-19T14:30:00Z | Copilot | ATOMIC SNAPSHOT REDESIGN: Completely removed signature-based autosave, reconciliation effects, and drift correction. Snapshots now save explicitly at checkpoints only: after each teaching sentence spoken (vocab/examples), after each Q&A question answered (comprehension/exercise/worksheet/test). Restore applies saved state exactly with no post-restore modifications. Deleted: snapshotSigMemo, autosave effects (ticker/state-change), resume reconciliation effect, 2-second post-restore guard. Simplified scheduleSaveSnapshot to direct save without debounce/signature/retry logic. Goal: eliminate Frankenstein complexity, stop restored state from drifting. Files: src/app/session/hooks/useSnapshotPersistence.js (removed ~200 lines reconciliation logic), src/app/session/hooks/useTeachingFlow.js (added explicit save calls after sentences), src/app/session/page.js (added explicit save calls after questions, removed snapshotSigMemo destructuring). RISK: Timer persistence 90% chance of breaking per user warning, will require separate debug day.
2025-11-19T01:45:00Z | Copilot | CRITICAL FIX: Zombie snapshot bug resolved. dbGetSnapshot now orders by updated_at DESC and limits to 1 before maybeSingle(), ensuring newest snapshot is always selected. Previous query returned arbitrary row when multiple snapshots existed for same key, causing old "Dragon King" snapshot to resurrect on every refresh despite newer saves succeeding. Files: src/app/api/snapshots/route.js.
2025-11-19T01:30:00Z | Copilot | CRITICAL REVERT: Restored original lessonData.id requirement for snapshot restore. Previous "any stable key" change (lines 457-460) caused restore to run too early before lessonData loaded, find no snapshots, mark as restored, then never retry when lessonData finally arrived. Resume/Restart buttons disappeared because snapshots existed but were never found. Files: src/app/session/hooks/useSnapshotPersistence.js.
2025-11-19T01:15:00Z | Copilot | SNAPSHOT AUTOSAVE UNBLOCK: When keys.length===0, now marks restoredSnapshotRef=true immediately so autosaves can begin instead of infinite postponement. Files: src/app/session/hooks/useSnapshotPersistence.js.
2025-11-19T00:50:00Z | Copilot | SNAPSHOT RESTORE SIMPLIFY: Removed sourcesReady postpone logic that was blocking restore completion—now always finalizes restore attempt and marks as restored so autosaves can start. Files: src/app/session/hooks/useSnapshotPersistence.js.
2025-11-18T05:55:00Z | Copilot | SNAPSHOT RESTORE FALLBACK: Restore/save now waits for any stable lesson key (id, manifest file, or slug) so book-based lessons without IDs keep saving snapshots instead of getting stuck on the opening. Files: src/app/session/hooks/useSnapshotPersistence.js.
2025-11-18T05:35:00Z | Copilot | TEACHING SNAPSHOT BRIDGE: Added proxy refs so snapshot persistence can call teaching-flow helpers before the hook initializes, fixing the getTeachingFlowSnapshot ReferenceError. Files: src/app/session/page.js.
2025-11-18T05:05:00Z | Copilot | TEACHING FLOW RESUME: Snapshot persistence now saves sentence-by-sentence teaching progress so Resume continues mid-definition/example instead of replaying the same intro. Files: src/app/session/hooks/useTeachingFlow.js, src/app/session/hooks/useSnapshotPersistence.js, src/app/session/sessionSnapshotStore.js, src/app/session/page.js.
2025-11-18T04:35:00Z | Copilot | SNAPSHOT NORMALIZATION: Supabase snapshot sanitization now keeps generated question lists, congrats flags, and timer/work states so resume restores the exact prior context. Files: src/app/session/sessionSnapshotStore.js.
2025-11-18T04:05:00Z | Copilot | TEACHING RESUME CALM: Resume no longer replays intros or fires the "Do you have any questions?" gate before vocab sentences finish—handleResumeClick now treats definitions/examples as repeats and skips the extra prompt. Files: src/app/session/hooks/useResumeRestart.js.
2025-11-18T00:45:00Z | Copilot | TIMER SNAPSHOT RELIABILITY: Timer refs now feed snapshot payloads before renders complete, and autosave signatures include timer/work state so play→work transitions persist across refresh. Files: src/app/session/page.js, src/app/session/hooks/useSnapshotPersistence.js.
2025-11-18T00:30:00Z | Copilot | CORRECTED: Removed incorrect timer mode guessing logic after drift from user requirements. Real issue: currentTimerMode empty in snapshots indicates timer initialization failure during normal operation. PLAY timer: Begin to Go button. WORK timer: Go button to next phase Begin. Timer modes should be set by startPhasePlayTimer/transitionToWorkTimer during normal flow, not inferred during restore. Files: src/app/session/hooks/useSnapshotPersistence.js (removed fallback logic).
2025-11-18T00:15:00Z | Copilot | CRITICAL FIX: Timer rendering after snapshot resume now works. Added timer mode initialization to handleResumeClick in useResumeRestart hook. When Resume button is pressed, sets default 'work' timer mode if none exists for current phase. Fixes issue where timers saved/restored in sessionStorage but wouldn't render due to missing currentTimerMode state. Files: src/app/session/hooks/useResumeRestart.js (timer initialization logic), src/app/session/page.js (currentTimerMode prop passing).
2025-11-17T23:55:00Z | Copilot | Enhanced date parser to support numeric formats (11/24, 11/24/25, MM/DD/YYYY) with US format preference, two-digit year expansion (25→2025), and smart year inference. Files: src/app/facilitator/generator/counselor/MentorInterceptor.js (extractDate function).
2025-11-17T23:50:00Z | Copilot | Added comprehensive loading thought bubbles for Mr. Mentor across all flows and API stages. Shows contextual thoughts during generate (topic/grade/subject/difficulty/title), schedule (date/lesson search), edit, recall, search, API forwarding, tool processing, validation, follow-up. Prioritizes loading thought over tool thought. Files: src/app/facilitator/generator/counselor/CounselorClient.jsx (getLoadingThought helper, 15 setLoadingThought calls), state integration with MentorThoughtBubble.
2025-11-17T23:48:00Z | Copilot | Added post-generation schedule handler to MentorInterceptor. After lesson generation, asks "Would you like to schedule this lesson?", detects yes/no confirmation, routes yes→schedule flow with selectedLesson pre-populated, routes no→reset. Completes generate→schedule seamless flow. Files: src/app/facilitator/generator/counselor/MentorInterceptor.js (post_generation_schedule case in handleParameterInput).
2025-11-17T23:45:00Z | Copilot | Created comprehensive MentorInterceptor architecture documentation covering all 5 flows, state machine, integration, and rollback plan. Files: docs/brain/MentorInterceptor_Architecture.md (570 lines).
2025-11-17T23:30:00Z | Copilot | Fixed allLessons structure for interceptor (object with subject keys, not flat array). Added recall "more" handling for paginated conversation matches. Files: src/app/facilitator/generator/counselor/MentorInterceptor.js (32 lines), CounselorClient.jsx (loadAllLessons rewritten).
2025-11-17T23:15:00Z | Copilot | Integrated MentorInterceptor with CounselorClient. Added loadAllLessons helper, interceptor.process() call before API, TTS for interceptor responses, action execution (schedule/generate/edit). Interceptor now fully wired into conversation flow. Files: src/app/facilitator/generator/counselor/CounselorClient.jsx (169 insertions, 5 deletions).