# Cohere Pack (Sidekick Recon) - MsSonoma

Project: freehands
Profile: MsSonoma
Mode: standard

Prompt (original):
```text
Where is /facilitator/doesnotexist implemented?
```

Filter terms used:
```text
/facilitator/doesnotexist
```
# Context Pack

**Project**: freehands
**Profile**: MsSonoma
**Mode**: standard

## Pack Contract

This pack is mechanically assembled: forced canonical context first, then ranked evidence until relevance saturates.

## Question

/facilitator/doesnotexist

## Forced Context

(none)

## Ranked Evidence

### 1. docs/reference/cohere/gaps/20260218_174208Z_recon-gap-doesnotexist-xyz.md (d4536ceab2512614191e12df06a4384b0da22bd8282cf25c77d3749a88fc3ba9)
- bm25: -10.6085 | relevance: 1.0000

Ôªø# Recon Gap Note: Recon gap: /doesnotexist/xyz

Date (UTC): 2026-02-18T17:42:08Z

## Recon prompt (exact)

Explain /doesnotexist/xyz and src/not-real/file.js

## Anchors

- /doesnotexist/xyz

## What the user sees / can do

-

## Key files / entrypoints

- src/not-real/file.js

## Notes

-

## Suggested next recon prompt

Where is <route/feature> implemented? Include the user-visible controls and the API/storage it reads/writes.

### 2. sidekick_pack.md (38163e6913f67b7277ca8371364da42c96c99f1ba6363df1f919869bf604a1e8)
- bm25: -10.0263 | relevance: 1.0000

# Cohere Pack (Sidekick Recon) - MsSonoma

Project: freehands
Profile: MsSonoma
Mode: standard

Prompt (original):
```text
Explain /doesnotexist/xyz and src/not-real/file.js
```

Filter terms used:
```text
src/not-real/file.js
/doesnotexist/xyz
/not-real/file
file.js
```
# Context Pack

**Project**: freehands
**Profile**: MsSonoma
**Mode**: standard

## Pack Contract

This pack is mechanically assembled: forced canonical context first, then ranked evidence until relevance saturates.

## Question

src/not-real/file.js /doesnotexist/xyz /not-real/file file.js

## Forced Context

(none)

## Ranked Evidence

### 1. sidekick_pack.md (d67c20cbf1eb1419cc41f989f98dcc7e1ff93c9ba2860e1ff0edaef84c4a8f35)
- bm25: -58.6123 | entity_overlap_w: 53.10 | adjusted: -71.8873 | relevance: 1.0000

# Cohere Pack (Sidekick Recon) - MsSonoma

Project: freehands
Profile: MsSonoma
Mode: standard

Prompt (original):
```text
Explain /doesnotexist/xyz and src/not-real/file.js
```

Filter terms used:
```text
src/not-real/file.js
/doesnotexist/xyz
/not-real/file
file.js
```
# Context Pack

**Project**: freehands
**Profile**: MsSonoma
**Mode**: standard

## Pack Contract

This pack is mechanically assembled: forced canonical context first, then ranked evidence until relevance saturates.

## Question

src/not-real/file.js /doesnotexist/xyz /not-real/file file.js

## Forced Context

(none)

## Ranked Evidence

### 1. sidekick_pack.md (bde1b82f978876de27e4ad60ee44083372eb2abdba78021cb83ba36b4b05b71e)
- bm25: -60.4824 | entity_overlap_w: 53.10 | adjusted: -73.7574 | relevance: 1.0000

# Cohere Pack (Sidekick Recon) - MsSonoma

Project: freehands
Profile: MsSonoma
Mode: standard

Prompt (original):
```text
Explain /doesnotexist/xyz and src/not-real/file.js
```

### 3. sidekick_pack.md (a7920f3892594e7f92e89473f0c79468e265c54abf33ecd346ec9ba2fcf74ca4)
- bm25: -9.1477 | relevance: 1.0000

src/not-real/file.js /doesnotexist/xyz /not-real/file file.js

### 4. sidekick_pack.md (0354d942092e4b7a723f8b49061a99b0093db14b459f5146aa6c16041e06a949)
- bm25: -8.8625 | relevance: 1.0000

Filter terms used:
```text
src/not-real/file.js
/doesnotexist/xyz
/not-real/file
file.js
```
# Context Pack

### 5. sidekick_pack.md (84c0364bea2ebfba4d249e58ce743a6d1797ceae82528b49750309a6cb641025)
- bm25: -8.7228 | relevance: 1.0000

**Project**: freehands
**Profile**: MsSonoma
**Mode**: standard

## Pack Contract

This pack is mechanically assembled: forced canonical context first, then ranked evidence until relevance saturates.

## Question

src/not-real/file.js /doesnotexist/xyz /not-real/file file.js

## Forced Context

(none)

## Ranked Evidence

### 1. sidekick_pack.md (7bfbbf4dd2839680af1039c4da36a491dac4b46d67796f9ce66f64cd6f11e440)
- bm25: -60.4252 | entity_overlap_w: 53.10 | adjusted: -73.7002 | relevance: 1.0000

# Cohere Pack (Sidekick Recon) - MsSonoma

Project: freehands
Profile: MsSonoma
Mode: standard

Prompt (original):
```text
Explain /doesnotexist/xyz and src/not-real/file.js
```

### 2. sidekick_pack.md (bea2df7e718afbad194cf0281d7e0936513a96d0d1bf240dd15d58f528ed531a)
- bm25: -52.6864 | entity_overlap_w: 29.60 | adjusted: -60.0864 | relevance: 1.0000

**Project**: freehands
**Profile**: MsSonoma
**Mode**: standard

## Pack Contract

This pack is mechanically assembled: forced canonical context first, then ranked evidence until relevance saturates.

## Question

src/not-real/file.js /doesnotexist/xyz /not-real/file file.js

## Forced Context

(none)

## Ranked Evidence

### 1. sidekick_pack.md (33a357132ac7ea2324fbe9010d0053075a23930ca59d2c0600329c8b403d5ebc)
- bm25: -63.6541 | entity_overlap_w: 47.00 | adjusted: -75.4041 | relevance: 1.0000

# Cohere Pack (Sidekick Recon) - MsSonoma

Project: freehands
Profile: MsSonoma
Mode: standard

Prompt (original):
```text
Explain /doesnotexist/xyz and src/not-real/file.js
```

### 2. sidekick_pack.md (29a1c65d8aaa67342a1580079f30a5590af4752852bd3ffd3a206c7def44569a)
- bm25: -55.5219 | entity_overlap_w: 32.20 | adjusted: -63.5719 | relevance: 1.0000

**Project**: freehands
**Profile**: MsSonoma
**Mode**: standard

## Pack Contract

### 6. sidekick_pack.md (bfb0e99ffa802cbd0ea32d256c56a6269f5c47349a1400bf3fc5ae6bfc52287a)
- bm25: -8.6895 | relevance: 1.0000

## Question

src/not-real/file.js /doesnotexist/xyz /not-real/file file.js

## Forced Context

(none)

## Ranked Evidence

### 1. sidekick_pack.md (0af7fa18f2c7167198a5e3c31b0e53e9b35f1df4168ed796b609ab9d1199fec9)
- bm25: -55.4926 | entity_overlap_w: 23.50 | adjusted: -61.3676 | relevance: 1.0000

# Cohere Pack (Sidekick Recon) - MsSonoma

Project: freehands
Profile: MsSonoma
Mode: standard

Prompt (original):
```text
Explain /doesnotexist/xyz and src/not-real/file.js
```

### 2. sidekick_pack.md (8ad127cdea10b819be86c1ceec6a58bd186b5dc252e46125b7beca482e831554)
- bm25: -56.7722 | entity_overlap_w: 8.70 | adjusted: -58.9472 | relevance: 1.0000

### 3. sidekick_pack.md (0eda1e4d717ab1496e3f04b3a2ce00ee2d1029e57cfef8b47daefd4d1368335f)
- bm25: -55.1330 | entity_overlap_w: 8.70 | adjusted: -57.3080 | relevance: 1.0000

Filter terms used:
```text
src/not-real/file.js
/doesnotexist/xyz
/not-real/file
file.js
```
# Context Pack

### 4. sidekick_pack.md (ad5191d04a54a80bc6ad27bda13aeb9bb2bfbcfe10427c88fdc335d190da6ba3)
- bm25: -55.1330 | entity_overlap_w: 8.70 | adjusted: -57.3080 | relevance: 1.0000

Filter terms used:
```text
src/not-real/file.js
/doesnotexist/xyz
/not-real/file
file.js
```
# Context Pack

### 5. sidekick_pack.md (f72e06b22c783214295568cf3d9940410799f3229307609caececc5c3bf03d47)
- bm25: -50.2386 | entity_overlap_w: 17.40 | adjusted: -54.5886 | relevance: 1.0000

### 3. sidekick_pack.md (4641b4bfa2044efb4481a2766112887a91163adc2a956185dbf21f225c4781d8)
- bm25: -38.9504 | entity_overlap_w: 8.70 | adjusted: -41.1254 | relevance: 1.0000

**Project**: freehands
**Profile**: MsSonoma
**Mode**: standard

## Pack Contract

This pack is mechanically assembled: forced canonical context first, then ranked evidence until relevance saturates.

## Question

### 7. sidekick_pack.md (0d8204f10332b1099c44949afe952677325e940af0c9e73100cd69a96fb50b10)
- bm25: -5.0289 | relevance: 1.0000

## Forced Context

(none)

## Ranked Evidence

### 1. docs/brain/lesson-library-downloads.md (ea6c987f912e08a4811e52893de3701d5c14ec17ac6ba2a12fed4b2d9135d9b9)
- bm25: -21.9787 | relevance: 1.0000

### API

### 2. sidekick_pack.md (2a831846fc56b602bc1cd6410dcb756d64b712656f3c6a6e0f7011b83ff69382)
- bm25: -24.3380 | relevance: 1.0000

### 3. sidekick_pack.md (a01c34d2be1553531903f0c65461fa8971c6e9d596f107e6521339f77b81910e)
- bm25: -56.8256 | entity_overlap_w: 8.70 | adjusted: -59.0006 | relevance: 1.0000

Filter terms used:
```text
src/not-real/file.js
/doesnotexist/xyz
/not-real/file
file.js
```
# Context Pack

### 4. sidekick_pack.md (5c51c7e9da7a42b25a2cc69017a35f48ce9bdb75e6e85a4c7c71921bc354f9d6)
- bm25: -23.0352 | relevance: 1.0000

### 6. sidekick_pack.md (283b64935c499dff1e604382dbb63a0809c83edc17a2b0405b384f7f86adf721)
- bm25: -25.1690 | relevance: 1.0000

### 18. docs/brain/account-provisioning.md (47da22602f3389633ba6dddba4339d7e7cd957c89f47fbea9033fe52e1b8249e)
- bm25: -16.1047 | relevance: 1.0000

### 4. sidekick_pack.md (96a3a510a22410499cf66014cdc1acd337523bd21a42c0b9d013f860226e7bc6)
- bm25: -26.7873 | relevance: 1.0000

This allows an operator to share a simple login instruction ("Email: DEMO") while still using a real Supabase Auth user.

## What NOT To Do

### 3. docs/brain/lesson-library-downloads.md (ea6c987f912e08a4811e52893de3701d5c14ec17ac6ba2a12fed4b2d9135d9b9)
- bm25: -20.4937 | relevance: 1.0000

### API

- `POST /api/facilitator/lessons/download`
  - Auth: requires `Authorization: Bearer <access_token>`.
  - Input: `{ subject, file }`.
  - Server reads the built-in file from `public/lessons/<subjectFolder>/<file>.json`.
  - Server uploads to Supabase Storage path `facilitator-lessons/<userId>/<file>.json` with `upsert: true`.

### 8. src/lib/faq/facilitator-pages.json (4b848d3bcb8fd074168f4bfd8805c4c4143f1f27948661b54e4fbba3e5eaf7e3)
- bm25: -0.6755 | relevance: 1.0000

{
  "category": "Facilitator Pages",
  "features": [
    {
      "id": "facilitator-page-hub",
      "title": "Facilitator Hub (/facilitator)",
      "keywords": [
        "facilitator hub",
        "facilitator home",
        "facilitator dashboard page",
        "/facilitator",
        "account learners lessons calendar",
        "talk to mr mentor"
      ],
      "description": "The Facilitator Hub is the entry point to adult tools. It shows quick links to Account, Learners, Lessons, Calendar, and Mr. Mentor.",
      "howToUse": "Use the cards to open a section (Account/Learners/Lessons/Calendar). Use the Mr. Mentor button to open the facilitator chat experience.",
      "relatedFeatures": ["facilitator-dashboard", "mr-mentor", "pin-security"]
    },
    {
      "id": "facilitator-page-account",
      "title": "Account (/facilitator/account)",
      "keywords": [
        "facilitator account",
        "account page",
        "profile",
        "security",
        "2fa",
        "connected accounts",
        "timezone",
        "marketing emails",
        "policies",
        "danger zone",
        "/facilitator/account"
      ],
      "description": "The Account page is the central place to manage facilitator profile and security settings, connections, hotkeys, timezone, and billing links.",
      "howToUse": "Open a card to edit: Your Name; Email and Password; Two-Factor Auth; Facilitator PIN; Connected Accounts; Hotkeys; Timezone; Marketing Emails; Policies; Plan; Danger Zone. Notifications is also linked from here.",
      "relatedFeatures": ["pin-security", "subscription-tiers"]
    },
    {
      "id": "facilitator-page-account-settings-redirect",
      "title": "Account Settings (Redirect) (/facilitator/account/settings)",
      "keywords": [
        "account se

### 9. docs/brain/pin-protection.md (771d09bf70621a2a47da98e3ac52455b98299582fe3c7fc3744c6d3234d5db17)
- bm25: -0.6676 | relevance: 1.0000

**Facilitator Pages** (all check PIN on mount):
- `src/app/facilitator/page.js` - Main facilitator hub
- `src/app/facilitator/learners/page.js` - Learner management
- `src/app/facilitator/lessons/page.js` - Lesson management
- `src/app/facilitator/generator/*/page.js` - Content generators
- `src/app/facilitator/account/*/page.js` - Account pages

### 10. docs/brain/pin-protection.md (099075fb976b0dc884d23cec569d3b693ff409180962ef058793b7f53217859f)
- bm25: -0.6515 | relevance: 1.0000

Session surfaces that mutate session state should gate with `ensurePinAllowed(action)` before performing the action.

**Session V2 (timeline + timer controls):**
- Timeline jumps call `ensurePinAllowed('timeline')` before switching phases.
- Timer controls call `ensurePinAllowed('timer')` before opening the timer control overlay and before pause/resume toggles.

**Games (example: Platform Jumper):**
- Facilitator-only game shortcuts (like skipping to a level) must call `ensurePinAllowed('skip')` before opening any level picker.

### Facilitator Section Flag

**Purpose**: Prevent double PIN prompts when navigating between facilitator pages

**How it works**:
1. Flag is stored in `sessionStorage` (cleared when browser tab closes)
2. When `ensurePinAllowed('facilitator-page')` succeeds, it sets the flag
3. Subsequent `facilitator-page` checks skip PIN if flag is already set
4. Flag is cleared when user navigates away from `/facilitator/*` routes

### Navigation Flow (Session ‚Üí Facilitator)

**Before Fix (Double PIN Prompt)**:
1. User clicks Facilitator link from session page
2. HeaderBar calls `ensurePinAllowed('session-exit')` ‚Üí prompts for PIN
3. Navigation to `/facilitator` happens
4. Facilitator page calls `ensurePinAllowed('facilitator-page')` ‚Üí prompts for PIN AGAIN (flag not set)

**After Fix (Single PIN Prompt)**:
1. User clicks Facilitator link from session page
2. HeaderBar calls `ensurePinAllowed('session-exit')` ‚Üí prompts for PIN
3. HeaderBar detects destination is facilitator route ‚Üí calls `setInFacilitatorSection(true)`
4. Navigation to `/facilitator` happens
5. Facilitator page calls `ensurePinAllowed('facilitator-page')` ‚Üí SKIPS PIN (flag already set)

### Server Verification

### 11. docs/brain/facilitator-hub.md (da9aec6fdfc1ea2738cb90fb2977c145f037ea8248bca3683693f7940f7ecae9)
- bm25: -0.6480 | relevance: 1.0000

# Facilitator Hub

## How It Works

The Facilitator hub is the main entry point for facilitator workflows at `/facilitator`.

- It shows a small grid of primary sections (cards) that route to key areas.
- It displays the current subscription tier as informational status.
- Billing is treated as part of **Account** (plan + billing lives under `/facilitator/account/*`).

## What NOT To Do

- Do not add a separate "Billing" section on the hub. Billing navigation belongs under **Account**.
- Do not duplicate billing management UIs on the hub. Use the account plan/billing pages.

## Key Files

- `src/app/facilitator/page.js` - Facilitator hub cards and subscription status display
- `src/app/facilitator/account/page.js` - Account hub (settings overlays)
- `src/app/facilitator/account/plan/page.js` - Plans & billing entry point
- `src/app/billing/manage/*` - Billing portal UI

### 12. docs/brain/pin-protection.md (a572b2eaa4ac61bc5c6c926b97a5f45498691130f5af49873ea35f306e9ecc36)
- bm25: -0.6402 | relevance: 1.0000

# PIN Protection System

## Overview

PIN protection gates access to facilitator features and controls session exits. The system prevents learners from accessing facilitator tools, downloads, or modifying session state without adult supervision.

## How It Works

### Core Components

**pinGate.js** (`src/app/lib/pinGate.js`)
- Central PIN validation utility
- Manages facilitator section tracking
- Provides `ensurePinAllowed(action)` function for gating actions
- Stores PIN preferences in localStorage and server

**FacilitatorSectionTracker.jsx** (`src/components/FacilitatorSectionTracker.jsx`)
- Tracks when user enters/leaves facilitator section
- Clears facilitator section flag when navigating away from `/facilitator/*`
- Mounted in root layout to track all navigation

**HeaderBar.js** (`src/app/HeaderBar.js`)
- Implements navigation PIN checks
- Sets facilitator section flag when navigating from session to facilitator
- Prevents double PIN prompts

### PIN Actions

Each action type maps to a preference key that controls whether PIN is required:

| Action | Preference Key | When Triggered | Sets Facilitator Flag? |
|--------|---------------|----------------|----------------------|
| `facilitator-page` | `facilitatorPage` | Entering any `/facilitator/*` page | YES |
| `session-exit` | `activeSession` | Leaving active lesson session | NO (but sets flag if destination is facilitator) |
| `download` | `downloads` | Worksheet/test downloads | NO |
| `facilitator-key` | `facilitatorKey` | Combined answer key | NO |
| `skip` / `timeline` | `skipTimeline` | Timeline jumps, skip buttons | NO |
| `change-learner` | `changeLearner` | Switching learners | NO |
| `refresh` | `refresh` | Re-generate worksheet/test | NO |
| `timer` | `timer` | Pause/resume timer | NO |

### 13. docs/brain/notifications-system.md (2d68facb9ef84811553c594d04831c5bab53537f01c38d56acdc06752047caaf)
- bm25: -0.6373 | relevance: 1.0000

# Notifications System

**Last updated**: 2026-01-08T13:36:08Z  
**Status**: Canonical

## How It Works

The Notifications system provides facilitator-facing alerts that persist across devices.

### Data Model (Supabase)

Notifications are stored per facilitator in Supabase (Postgres) under RLS.

**Tables**:
- `public.facilitator_notifications`
  - Per-notification rows (title/body/type/category)
  - `read_at` marks a notification as read
  - `facilitator_id` is the owner and must equal `auth.uid()` under RLS

- `public.facilitator_notification_prefs`
  - Per-facilitator preferences that control which categories are enabled
  - Includes a master `enabled` toggle

### Current UI

**Notifications page**: `/facilitator/notifications`
- Shows a list of notifications
- Each row can be marked read/unread via a checkmark button
- A gear button opens a settings overlay to control notification preferences

**Account page launcher**: `/facilitator/account`
- Shows a Notifications card matching existing Account card styling
- Clicking navigates to `/facilitator/notifications`

**Header quick-link**:
- The Facilitator hover dropdown includes a Notifications item that navigates to `/facilitator/notifications`

### Placeholder Behavior

The UI currently seeds a small set of demo notifications for a facilitator if they have zero notifications. This is intentionally temporary and exists only to make the manager usable before event producers are wired.

## What NOT To Do

### 14. docs/brain/ingests/pack-mentor-intercepts.md (ee64f00174c13b58457962dbc2cdb20aa52435a52a1fa39ebeca6ea8bf379fe2)
- bm25: -0.6303 | relevance: 1.0000

- `src/app/facilitator/page.js` - Facilitator hub cards and subscription status display
- `src/app/facilitator/account/page.js` - Account hub (settings overlays)
- `src/app/facilitator/account/plan/page.js` - Plans & billing entry point
- `src/app/billing/manage/*` - Billing portal UI

### 15. sidekick_pack_lessons_prefetch.md (c2cf5bf3ad627a5e90407d82ebdbcdb0ecc148498a13c5ab029ef56071e17508)
- bm25: -0.6263 | relevance: 1.0000

// Default behavior: prefer facilitator-scoped schedule rows, plus safe legacy rows where facilitator_id is null.
    // Overlay/debug callers can pass includeAll=1 to retrieve all schedule rows for an owned learner.
    if (!includeAll) {
      query = query.or(`facilitator_id.eq.${user.id},facilitator_id.is.null`)
    }

### 16. scripts/add-mentor-conversation-threads.sql (2298cd617a823bf44e0fc7409f5473e4aca9ec2ba50162da04ef527049f206d7)
- bm25: -0.6253 | relevance: 1.0000

DROP POLICY IF EXISTS "Users can manage their own mentor conversation threads" ON public.mentor_conversation_threads;
CREATE POLICY "Users can manage their own mentor conversation threads"
  ON public.mentor_conversation_threads
  FOR ALL
  USING (auth.uid() = facilitator_id)
  WITH CHECK (auth.uid() = facilitator_id);

GRANT ALL ON public.mentor_conversation_threads TO authenticated;
GRANT USAGE ON ALL SEQUENCES IN SCHEMA public TO authenticated;

COMMENT ON TABLE public.mentor_conversation_threads IS 'Per-subject Mr. Mentor conversations (facilitator + each learner), independent of device ownership.';
COMMENT ON COLUMN public.mentor_conversation_threads.subject_key IS 'Conversation scope key, e.g. facilitator or learner:<uuid>.';

-- 4) Optional: backfill existing single conversation into facilitator thread (best-effort)
-- Inserts a facilitator thread for facilitators that have any mentor_sessions row.
INSERT INTO public.mentor_conversation_threads (facilitator_id, subject_key, conversation_history, draft_summary, token_count, last_local_update_at, last_activity_at)
SELECT
  ms.facilitator_id,
  'facilitator' AS subject_key,
  COALESCE(ms.conversation_history, '[]'::jsonb) AS conversation_history,
  ms.draft_summary,
  ms.token_count,
  ms.last_local_update_at,
  COALESCE(ms.last_activity_at, NOW()) AS last_activity_at
FROM public.mentor_sessions ms
WHERE ms.facilitator_id IS NOT NULL
ON CONFLICT (facilitator_id, subject_key) DO NOTHING;

### 17. docs/brain/custom-subjects.md (fd8a5ead4d8a64f78e034e3ca6a8d9b6dea9dbbdcd408f13f17042a7b16d3e24)
- bm25: -0.6253 | relevance: 1.0000

# Custom Subjects (Per Facilitator)

## How It Works

- Custom subjects are stored in the Supabase table `custom_subjects` and are scoped to a single facilitator via `facilitator_id`.
- The canonical API surface is `GET/POST/DELETE /api/custom-subjects`.
  - `GET` returns `{ subjects: [...] }` ordered by `display_order` then `name`.
  - `POST` creates a subject for the authenticated facilitator.
  - `DELETE` deletes a subject only if it belongs to the authenticated facilitator.
- Client surfaces that need subject dropdown options should treat subjects as:
  - Core subjects (universal): `math`, `science`, `language arts`, `social studies`, `general`.
  - Custom subjects (per facilitator): fetched from `/api/custom-subjects` using the facilitator session token.
  - Special subject `generated` is a UI bucket used in some facilitator/Mr. Mentor views (not a custom subject). In the Mr. Mentor lessons overlay, `generated` is intentionally not shown as a subject dropdown option.
- Shared client hook:
  - `useFacilitatorSubjects()` fetches custom subjects for the signed-in facilitator and returns merged dropdown-ready lists.

## What NOT To Do

- Do not make custom subjects global. They must remain per-facilitator (`custom_subjects.facilitator_id`).
- Do not fetch public lesson lists for custom subjects. Only core subjects have public lesson endpoints (`/api/lessons/[subject]`).
- Do not store custom subjects in browser storage as the source of truth.

## Key Files

### 18. sidekick_pack_api_mentor_session.md (6a4e308d5326bc08dc43d55d77a917dca49981ecbaa22e641c0c8d8df1915c92)
- bm25: -0.6252 | relevance: 1.0000

// Default behavior: prefer facilitator-scoped schedule rows, plus safe legacy rows where facilitator_id is null.
    // Overlay/debug callers can pass includeAll=1 to retrieve all schedule rows for an owned learner.
    if (!includeAll) {
      query = query.or(`facilitator_id.eq.${user.id},facilitator_id.is.null`)
    }

### 19. docs/brain/notifications-system.md (93a5534adce123be1e4b6b6cd12e7ac6547924ea1b7068e72452c88c60c31470)
- bm25: -0.6252 | relevance: 1.0000

## Key Files

- `src/app/facilitator/notifications/page.js` - Notifications manager page UI
- `src/app/facilitator/account/page.js` - Account launcher card
- `src/app/HeaderBar.js` - Facilitator dropdown link
- `src/app/lib/facilitatorNotificationsClient.js` - Supabase read/write helpers
- `supabase/migrations/20260108133500_add_facilitator_notifications.sql` - Tables + RLS policies

### 20. src/app/api/lesson-schedule/route.js (4e331f192a6c56a4cab8c5f7afbe0982981f3bd236880d62edeea56744dbb7e2)
- bm25: -0.6242 | relevance: 1.0000

// Default behavior: prefer facilitator-scoped schedule rows, plus safe legacy rows where facilitator_id is null.
    // Overlay/debug callers can pass includeAll=1 to retrieve all schedule rows for an owned learner.
    if (!includeAll) {
      query = query.or(`facilitator_id.eq.${user.id},facilitator_id.is.null`)
    }

### 21. docs/brain/mr-mentor-sessions.md (c1a7c3b42cd39d87f3ed7193003f236259b5d2994608f67e50930fa3e357246e)
- bm25: -0.6227 | relevance: 1.0000

-- Unique constraint: Only one active session per facilitator
CREATE UNIQUE INDEX idx_mentor_sessions_active_facilitator 
ON mentor_sessions (facilitator_id) 
WHERE is_active = true;
```

### 22. docs/brain/manifest.json (c84e253717b47212b1719debc33ac92047bd5a6c13afe3f7e47485e845256ff6)
- bm25: -0.6214 | relevance: 1.0000

{
  "facilitator-hub": {
    "file": "facilitator-hub.md",
    "systems": [
      "/facilitator",
      "hub-cards",
      "account",
      "billing-placement",
      "subscription-status"
    ],
    "last_updated": "2026-01-08T02:06:48Z",
    "status": "canonical"
  },
  "header-navigation": {
    "file": "header-navigation.md",
    "systems": [
      "HeaderBar",
      "top-nav-links",
      "facilitator-dropdown",
      "session-exit-pin-gate",
      "print-menu"
    ],
    "last_updated": "2026-01-27T19:27:45Z",
    "status": "canonical"
  },
  "homepage": {
    "file": "homepage.md",
    "systems": [
      "/",
      "home hero",
      "mssonoma.com",
      "external link",
      "learn-more copy"
    ],
    "last_updated": "2026-01-10T19:44:15Z",
    "status": "canonical"
  },
  "custom-subjects": {
    "file": "custom-subjects.md",
    "systems": [
      "custom_subjects",
      "/api/custom-subjects",
      "per-facilitator subjects",
      "subject dropdowns",
      "Mr. Mentor subjects"
    ],
    "last_updated": "2026-01-10T20:06:44Z",
    "status": "canonical"
  },
  "notifications-system": {
    "file": "notifications-system.md",
    "systems": [
      "facilitator notifications",
      "/facilitator/notifications",
      "facilitator_notifications",
      "facilitator_notification_prefs",
      "read_at",
      "notification settings",
      "no-localStorage"
    ],
    "last_updated": "2026-01-08T13:36:08Z",
    "status": "canonical"
  },
  "dev-server-and-chunks": {
    "file": "dev-server-and-chunks.md",
    "systems": [
      "next-dev",
      "chunk-404",
      "_next-static-chunks",
      "distDir",
      "next-config",
      "cache-clean",
      "restart-dev-3001"
    ],
    "last_updated": "2026-01-01T05:20:00Z",
    "status": "canonical"
  },
  "g

### 23. docs/brain/lesson-validation.md (6bd47820aa3da6e19dc9b0a9c78ca88859dc4dd6752d036fea1a2fe4318d515b)
- bm25: -0.6212 | relevance: 1.0000

**Lesson Maker** (`/facilitator/generator`, implemented in `src/app/facilitator/generator/page.js`):
1. User fills form and clicks "Generate Lesson"
2. Toast: "Generating lesson..."
3. Call `/api/facilitator/lessons/generate`
4. Validate with `lessonValidation.validateLesson()`
5. If issues: Toast "Improving quality...", call `/api/facilitator/lessons/request-changes`
6. Toast: "Lesson ready!"

### 24. docs/brain/ingests/pack.md (26cbfbfdc932653f646c2218ebaec8fa3fb19e5d960bc7766502c497351f374a)
- bm25: -0.6210 | relevance: 1.0000

{
  "facilitator-hub": {
    "file": "facilitator-hub.md",
    "systems": [
      "/facilitator",
      "hub-cards",
      "account",
      "billing-placement",
      "subscription-status"
    ],
    "last_updated": "2026-01-08T02:06:48Z",
    "status": "canonical"
  },
  "header-navigation": {
    "file": "header-navigation.md",
    "systems": [
      "HeaderBar",
      "top-nav-links",
      "facilitator-dropdown",
      "session-exit-pin-gate",
      "print-menu"
    ],
    "last_updated": "2026-01-27T19:27:45Z",
    "status": "canonical"
  },
  "homepage": {
    "file": "homepage.md",
    "systems": [
      "/",
      "home hero",
      "mssonoma.com",
      "external link",
      "learn-more copy"
    ],
    "last_updated": "2026-01-10T19:44:15Z",
    "status": "canonical"
  },
  "custom-subjects": {
    "file": "custom-subjects.md",
    "systems": [
      "custom_subjects",
      "/api/custom-subjects",
      "per-facilitator subjects",
      "subject dropdowns",
      "Mr. Mentor subjects"
    ],
    "last_updated": "2026-01-10T20:06:44Z",
    "status": "canonical"
  },
  "notifications-system": {
    "file": "notifications-system.md",
    "systems": [
      "facilitator notifications",
      "/facilitator/notifications",
      "facilitator_notifications",
      "facilitator_notification_prefs",
      "read_at",
      "notification settings",
      "no-localStorage"
    ],
    "last_updated": "2026-01-08T13:36:08Z",
    "status": "canonical"
  },
  "dev-server-and-chunks": {
    "file": "dev-server-and-chunks.md",
    "systems": [
      "next-dev",
      "chunk-404",
      "_next-static-chunks",
      "distDir",
      "next-config",
      "cache-clean",
      "restart-dev-3001"
    ],
    "last_updated": "2026-01-01T05:20:00Z",
    "status": "canonical"
  },
  "g

### 25. docs/brain/ingests/pack-mentor-intercepts.md (4dae7caeca0c56aeb7dad284f26e1f8a3bdc63e4132ae7b1ea978d78896eea4f)
- bm25: -0.6201 | relevance: 1.0000

{
  "facilitator-hub": {
    "file": "facilitator-hub.md",
    "systems": [
      "/facilitator",
      "hub-cards",
      "account",
      "billing-placement",
      "subscription-status"
    ],
    "last_updated": "2026-01-08T02:06:48Z",
    "status": "canonical"
  },
  "header-navigation": {
    "file": "header-navigation.md",
    "systems": [
      "HeaderBar",
      "top-nav-links",
      "facilitator-dropdown",
      "session-exit-pin-gate",
      "print-menu"
    ],
    "last_updated": "2026-01-27T19:27:45Z",
    "status": "canonical"
  },
  "homepage": {
    "file": "homepage.md",
    "systems": [
      "/",
      "home hero",
      "mssonoma.com",
      "external link",
      "learn-more copy"
    ],
    "last_updated": "2026-01-10T19:44:15Z",
    "status": "canonical"
  },
  "custom-subjects": {
    "file": "custom-subjects.md",
    "systems": [
      "custom_subjects",
      "/api/custom-subjects",
      "per-facilitator subjects",
      "subject dropdowns",
      "Mr. Mentor subjects"
    ],
    "last_updated": "2026-01-10T20:06:44Z",
    "status": "canonical"
  },
  "notifications-system": {
    "file": "notifications-system.md",
    "systems": [
      "facilitator notifications",
      "/facilitator/notifications",
      "facilitator_notifications",
      "facilitator_notification_prefs",
      "read_at",
      "notification settings",
      "no-localStorage"
    ],
    "last_updated": "2026-01-08T13:36:08Z",
    "status": "canonical"
  },
  "dev-server-and-chunks": {
    "file": "dev-server-and-chunks.md",
    "systems": [
      "next-dev",
      "chunk-404",
      "_next-static-chunks",
      "distDir",
      "next-config",
      "cache-clean",
      "restart-dev-3001"
    ],
    "last_updated": "2026-01-01T05:20:00Z",
    "status": "canonical"
  },
  "g

### 26. docs/brain/ingests/pack.lesson-schedule-debug.md (ff4a86926b331453f8f6a8fcb311c4367895cc33f5c1b641faf366e3ba113121)
- bm25: -0.6197 | relevance: 1.0000

{
  "facilitator-hub": {
    "file": "facilitator-hub.md",
    "systems": [
      "/facilitator",
      "hub-cards",
      "account",
      "billing-placement",
      "subscription-status"
    ],
    "last_updated": "2026-01-08T02:06:48Z",
    "status": "canonical"
  },
  "header-navigation": {
    "file": "header-navigation.md",
    "systems": [
      "HeaderBar",
      "top-nav-links",
      "facilitator-dropdown",
      "session-exit-pin-gate",
      "print-menu"
    ],
    "last_updated": "2026-01-27T19:27:45Z",
    "status": "canonical"
  },
  "homepage": {
    "file": "homepage.md",
    "systems": [
      "/",
      "home hero",
      "mssonoma.com",
      "external link",
      "learn-more copy"
    ],
    "last_updated": "2026-01-10T19:44:15Z",
    "status": "canonical"
  },
  "custom-subjects": {
    "file": "custom-subjects.md",
    "systems": [
      "custom_subjects",
      "/api/custom-subjects",
      "per-facilitator subjects",
      "subject dropdowns",
      "Mr. Mentor subjects"
    ],
    "last_updated": "2026-01-10T20:06:44Z",
    "status": "canonical"
  },
  "notifications-system": {
    "file": "notifications-system.md",
    "systems": [
      "facilitator notifications",
      "/facilitator/notifications",
      "facilitator_notifications",
      "facilitator_notification_prefs",
      "read_at",
      "notification settings",
      "no-localStorage"
    ],
    "last_updated": "2026-01-08T13:36:08Z",
    "status": "canonical"
  },
  "dev-server-and-chunks": {
    "file": "dev-server-and-chunks.md",
    "systems": [
      "next-dev",
      "chunk-404",
      "_next-static-chunks",
      "distDir",
      "next-config",
      "cache-clean",
      "restart-dev-3001"
    ],
    "last_updated": "2026-01-01T05:20:00Z",
    "status": "canonical"
  },
  "g

### 27. docs/brain/ingests/pack.mrmentor-calendar-overlay.md (d05d5d221a529b823920ad988a0fbf12f29278fe69a0c72a1bd1dd95072154f8)
- bm25: -0.6197 | relevance: 1.0000

{
  "facilitator-hub": {
    "file": "facilitator-hub.md",
    "systems": [
      "/facilitator",
      "hub-cards",
      "account",
      "billing-placement",
      "subscription-status"
    ],
    "last_updated": "2026-01-08T02:06:48Z",
    "status": "canonical"
  },
  "header-navigation": {
    "file": "header-navigation.md",
    "systems": [
      "HeaderBar",
      "top-nav-links",
      "facilitator-dropdown",
      "session-exit-pin-gate",
      "print-menu"
    ],
    "last_updated": "2026-01-27T19:27:45Z",
    "status": "canonical"
  },
  "homepage": {
    "file": "homepage.md",
    "systems": [
      "/",
      "home hero",
      "mssonoma.com",
      "external link",
      "learn-more copy"
    ],
    "last_updated": "2026-01-10T19:44:15Z",
    "status": "canonical"
  },
  "custom-subjects": {
    "file": "custom-subjects.md",
    "systems": [
      "custom_subjects",
      "/api/custom-subjects",
      "per-facilitator subjects",
      "subject dropdowns",
      "Mr. Mentor subjects"
    ],
    "last_updated": "2026-01-10T20:06:44Z",
    "status": "canonical"
  },
  "notifications-system": {
    "file": "notifications-system.md",
    "systems": [
      "facilitator notifications",
      "/facilitator/notifications",
      "facilitator_notifications",
      "facilitator_notification_prefs",
      "read_at",
      "notification settings",
      "no-localStorage"
    ],
    "last_updated": "2026-01-08T13:36:08Z",
    "status": "canonical"
  },
  "dev-server-and-chunks": {
    "file": "dev-server-and-chunks.md",
    "systems": [
      "next-dev",
      "chunk-404",
      "_next-static-chunks",
      "distDir",
      "next-config",
      "cache-clean",
      "restart-dev-3001"
    ],
    "last_updated": "2026-01-01T05:20:00Z",
    "status": "canonical"
  },
  "g

### 28. docs/brain/ingests/pack.planned-lessons-flow.md (196db63f29d528f16d0db6be45aadd46555525c550797b39a0c85f30162b04c4)
- bm25: -0.6197 | relevance: 1.0000

{
  "facilitator-hub": {
    "file": "facilitator-hub.md",
    "systems": [
      "/facilitator",
      "hub-cards",
      "account",
      "billing-placement",
      "subscription-status"
    ],
    "last_updated": "2026-01-08T02:06:48Z",
    "status": "canonical"
  },
  "header-navigation": {
    "file": "header-navigation.md",
    "systems": [
      "HeaderBar",
      "top-nav-links",
      "facilitator-dropdown",
      "session-exit-pin-gate",
      "print-menu"
    ],
    "last_updated": "2026-01-27T19:27:45Z",
    "status": "canonical"
  },
  "homepage": {
    "file": "homepage.md",
    "systems": [
      "/",
      "home hero",
      "mssonoma.com",
      "external link",
      "learn-more copy"
    ],
    "last_updated": "2026-01-10T19:44:15Z",
    "status": "canonical"
  },
  "custom-subjects": {
    "file": "custom-subjects.md",
    "systems": [
      "custom_subjects",
      "/api/custom-subjects",
      "per-facilitator subjects",
      "subject dropdowns",
      "Mr. Mentor subjects"
    ],
    "last_updated": "2026-01-10T20:06:44Z",
    "status": "canonical"
  },
  "notifications-system": {
    "file": "notifications-system.md",
    "systems": [
      "facilitator notifications",
      "/facilitator/notifications",
      "facilitator_notifications",
      "facilitator_notification_prefs",
      "read_at",
      "notification settings",
      "no-localStorage"
    ],
    "last_updated": "2026-01-08T13:36:08Z",
    "status": "canonical"
  },
  "dev-server-and-chunks": {
    "file": "dev-server-and-chunks.md",
    "systems": [
      "next-dev",
      "chunk-404",
      "_next-static-chunks",
      "distDir",
      "next-config",
      "cache-clean",
      "restart-dev-3001"
    ],
    "last_updated": "2026-01-01T05:20:00Z",
    "status": "canonical"
  },
  "g

### 29. src/lib/faq/facilitator-tools.json (01d1775600d96190823d9a009a124babf1c8c002bd0016694f7f2e5a685b8241)
- bm25: -0.6186 | relevance: 1.0000

{
  "category": "Facilitator Settings & Tools",
  "features": [
    {
      "id": "facilitator-dashboard",
      "title": "Facilitator Dashboard",
      "keywords": [
        "facilitator dashboard",
        "dashboard",
        "facilitator tools",
        "adult tools",
        "teacher tools"
      ],
      "description": "The Facilitator Dashboard is where you manage learners, lessons, scheduling, and account-level facilitator tools.",
      "howToUse": "Open the facilitator area and use the Learners and Lessons sections to manage your work. Mr. Mentor can also open key overlays for you.",
      "relatedFeatures": ["learner-profiles", "lesson-library", "mr-mentor"]
    },
    {
      "id": "goals-clipboard",
      "title": "Goals Clipboard",
      "keywords": [
        "goals clipboard",
        "goals button",
        "notes clipboard",
        "open goals"
      ],
      "description": "The Goals clipboard is the UI where you view and edit Goals and Notes for the selected learner (or facilitator).",
      "howToUse": "Click the 'Goals' button to open it. Mr. Mentor can also help you review what‚Äôs saved (report) or suggest what to write (describe/advice).",
      "relatedFeatures": ["goals-notes"]
    },
    {
      "id": "lessons-overlay",
      "title": "Lessons Overlay",
      "keywords": [
        "lessons overlay",
        "lessons button",
        "open lessons",
        "show my lessons",
        "lesson list"
      ],
      "description": "The Lessons overlay is a quick way to browse, search, and act on lessons (schedule, assign/approve, edit, or review).",
      "howToUse": "Click the 'Lessons' button, or ask Mr. Mentor to show lessons and help you find the one you want.",
      "relatedFeatures": ["lesson-library", "lesson-scheduling", "lesson-editing"]

### 30. sidekick_pack_lessons_prefetch.md (4f71a9873f3be2859f269bbc874e89cf26a453dc1352b707820cd5eadf96f1d8)
- bm25: -0.6174 | relevance: 1.0000

## Pack Contract

This pack is mechanically assembled: forced canonical context first, then ranked evidence until relevance saturates.

## Question

/api/mentor-session facilitator_id is_active SessionTakeoverDialog

## Forced Context

(none)

## Ranked Evidence

### 7. sidekick_pack_api_mentor_session.md (6a4e308d5326bc08dc43d55d77a917dca49981ecbaa22e641c0c8d8df1915c92)
- bm25: -20.7168 | relevance: 1.0000

// Default behavior: prefer facilitator-scoped schedule rows, plus safe legacy rows where facilitator_id is null.
    // Overlay/debug callers can pass includeAll=1 to retrieve all schedule rows for an owned learner.
    if (!includeAll) {
      query = query.or(`facilitator_id.eq.${user.id},facilitator_id.is.null`)
    }

### 8. src/app/api/lesson-schedule/route.js (4e331f192a6c56a4cab8c5f7afbe0982981f3bd236880d62edeea56744dbb7e2)
- bm25: -20.6258 | relevance: 1.0000

// Default behavior: prefer facilitator-scoped schedule rows, plus safe legacy rows where facilitator_id is null.
    // Overlay/debug callers can pass includeAll=1 to retrieve all schedule rows for an owned learner.
    if (!includeAll) {
      query = query.or(`facilitator_id.eq.${user.id},facilitator_id.is.null`)
    }

### 9. sidekick_pack_mentor_sessions_schema.md (455339344562db47239e8d791c805dc4f86ca4acf57144996acddf4d5af3842f)
- bm25: -19.9648 | relevance: 1.0000

SELECT 
  indexname,
  indexdef
FROM pg_indexes
WHERE tablename = 'mentor_sessions'
  AND indexname = 'unique_active_session_per_facilitator';

### 2. scripts/setup-mentor-sessions.sql (76419572d186bb374af9dfdf9f1b40251b639abdcfebe257c03215b4b394bc31)
- bm25: -35.6047 | entity_overlap_w: 1.00 | adjusted: -35.8547 | relevance: 1.0000

### 31. docs/brain/pin-protection.md (3aa2a8e5f407ed24098e9d06429a29a96012af85911782bdf9d220a708346647)
- bm25: -0.6159 | relevance: 1.0000

### Preferences

PIN preferences are stored in:
- Server: `profiles.pin_prefs` (JSON column)
- Client: `localStorage.facilitator_pin_prefs` (cached copy)

Default preferences (when PIN exists but prefs not set):
```javascript
{
  downloads: true,
  facilitatorKey: true,
  skipTimeline: true,
  changeLearner: true,
  refresh: true,
  timer: true,
  facilitatorPage: true,
  activeSession: true
}
```

## What NOT To Do

**‚ùå DON'T** set facilitator section flag for non-facilitator actions
- Only `facilitator-page` action and session-exit-to-facilitator navigation should set the flag
- Setting it for other actions would allow bypassing PIN on facilitator pages

**‚ùå DON'T** store PIN in localStorage
- PIN verification is server-only for security
- Never cache PIN validation results beyond sessionStorage flag

**‚ùå DON'T** create multiple PIN prompts simultaneously
- `ensurePinAllowed` uses global lock (`activePinPrompt`) to prevent concurrent prompts
- If another prompt is active, wait for its result

**‚ùå DON'T** forget to clear facilitator section flag when leaving facilitator routes
- FacilitatorSectionTracker handles this automatically
- Manual flag clearing should match its logic

**‚ùå DON'T** use `ensurePinAllowed` for non-gated features
- Only call it when you genuinely need to gate an action
- Unnecessary calls degrade user experience

## Key Files

**Core Logic**:
- `src/app/lib/pinGate.js` - PIN validation, section tracking, preferences
- `src/app/api/facilitator/pin/route.js` - Get PIN state, preferences
- `src/app/api/facilitator/pin/verify/route.js` - Server PIN verification

**Navigation Integration**:
- `src/app/HeaderBar.js` - Navigation PIN checks, facilitator flag setting
- `src/components/FacilitatorSectionTracker.jsx` - Section flag lifecycle

### 32. docs/brain/calendar-lesson-planning.md (1d396766db2440144971a1350400b34ef2799dc2339e2896f9d8c5a4a2c58fe0)
- bm25: -0.6135 | relevance: 1.0000

- `src/app/facilitator/calendar/LessonPicker.js`
  - Manual scheduling UI ("Add Lessons")
  - Loads ONLY facilitator-owned lessons via `/api/facilitator/lessons/list`
  - Produces `generated/<filename>` keys for scheduling and for `/api/lesson-file`

### 33. docs/brain/ingests/pack.planned-lessons-flow.md (0f7166c8532c44d946f304b21783d627e9b974887552cfc762d34feacecf6e85)
- bm25: -0.6109 | relevance: 1.0000

- `src/app/facilitator/calendar/LessonPicker.js`
  - Manual scheduling UI ("Add Lessons")
  - Loads ONLY facilitator-owned lessons via `/api/facilitator/lessons/list`
  - Produces `generated/<filename>` keys for scheduling and for `/api/lesson-file`

### 34. scripts/setup-mentor-sessions.sql (31afb0263b5558a382a0dcdba3cc50120e5e453cb20ca5d11f24299e8b7d64eb)
- bm25: -0.6046 | relevance: 1.0000

-- Mr. Mentor Session Management
-- Single-device enforcement and conversation persistence

-- Create mentor_sessions table
CREATE TABLE IF NOT EXISTS public.mentor_sessions (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  facilitator_id UUID NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,
  session_id TEXT NOT NULL, -- Browser-generated unique session ID
  device_name TEXT, -- Optional device identifier
  conversation_history JSONB NOT NULL DEFAULT '[]'::jsonb,
  draft_summary TEXT,
  last_activity_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  is_active BOOLEAN NOT NULL DEFAULT TRUE,
  
  -- Only one active session per facilitator
  CONSTRAINT unique_active_session_per_facilitator UNIQUE (facilitator_id, is_active)
);

-- Create index for quick lookups
CREATE INDEX IF NOT EXISTS idx_mentor_sessions_facilitator ON public.mentor_sessions(facilitator_id);
CREATE INDEX IF NOT EXISTS idx_mentor_sessions_session_id ON public.mentor_sessions(session_id);
CREATE INDEX IF NOT EXISTS idx_mentor_sessions_active ON public.mentor_sessions(facilitator_id, is_active) WHERE is_active = TRUE;

-- RLS policies
ALTER TABLE public.mentor_sessions ENABLE ROW LEVEL SECURITY;

-- Policy: Users can only access their own sessions
CREATE POLICY "Users can manage their own mentor sessions"
  ON public.mentor_sessions
  FOR ALL
  USING (auth.uid() = facilitator_id)
  WITH CHECK (auth.uid() = facilitator_id);

### 35. docs/brain/ingests/pack.md (84a96ac150f2135d31aa9bfe9cd8ac1e61d8f40743bcb440da0563dd1f1c1bb2)
- bm25: -0.6035 | relevance: 1.0000

### 13. docs/brain/header-navigation.md (17596087776b8a8510ebd6fdda83503d40ccdb8376bc76c97583cafb2888e681)
- bm25: -23.7972 | relevance: 1.0000

# Header Navigation

## How It Works

The global header (HeaderBar) is rendered across pages and provides:

- Brand link to home
- Back button on pages that define a back chain
- Top-level navigation links (About, Learn, Facilitator)
- Session-specific print menu actions

### Session Print Menu

On the Session page, the header shows a printer icon (desktop layout) that opens a small dropdown with print actions.

**Trigger behavior (desktop):** Open on hover (mouseenter) with a short grace period on mouseleave so it does not flicker closed while moving from the icon into the menu.

**Trigger behavior (touch / fallback):** The icon should also toggle the dropdown on click.

The dropdown includes print actions:

- Worksheet
- Test
- Facilitator Key
- Refresh

On narrow layouts, these same actions live inside the hamburger menu under a nested "Print" section.

Important: header buttons (including the print icon) must explicitly set `type="button"` so they never behave like submit buttons when a page happens to include a form.

Also: header dropdown trigger buttons must call `e.stopPropagation()` in their onClick handlers to prevent the opening click from bubbling to document and immediately triggering the outside-click-close listener.

### Facilitator Dropdown

On non-hamburger layouts, mouseovering the "Facilitator" header link opens a small dropdown menu with quick links:

- ‚öôÔ∏è Account -> `/facilitator/account`
- üîî Notifications -> `/facilitator/notifications`
- üë• Learners -> `/facilitator/learners`
- üìö Lessons -> `/facilitator/lessons`
- üìÖ Calendar -> `/facilitator/calendar`
- üß† Mr. Mentor -> `/facilitator/mr-mentor`

### 36. docs/brain/custom-subjects.md (7e58ee1ca5dc34b720347edc91b697304897f6b53937497421004d738d51df62)
- bm25: -0.6019 | relevance: 1.0000

- API
  - `src/app/api/custom-subjects/route.js`
- Shared subject utilities
  - `src/app/hooks/useFacilitatorSubjects.js`
  - `src/app/lib/subjects.js`
- UI surfaces that must reflect custom subjects
  - `src/app/facilitator/calendar/LessonPicker.js` (scheduler subject filter)
  - `src/app/facilitator/lessons/page.js` (lesson library subject filter)
  - `src/components/LessonEditor.jsx` (lesson subject field)
  - `src/app/facilitator/generator/page.js` (Lesson Maker)
  - `src/app/facilitator/generator/counselor/overlays/*` (Mr. Mentor overlays)

### 37. src/app/facilitator/generator/counselor/overlays/CalendarOverlay.jsx (75fb65f571a3dd5e38e700ab50147f3123152abd0c56b60134cd27c4296ea3ed)
- bm25: -0.6001 | relevance: 1.0000

// Compact calendar view for Mr. Mentor overlay
'use client'
import { useState, useEffect, useRef, useCallback } from 'react'
import { createPortal } from 'react-dom'
import { getSupabaseClient } from '@/app/lib/supabaseClient'
import LessonGeneratorOverlay from '@/app/facilitator/calendar/LessonGeneratorOverlay'
import LessonPlanner from '@/app/facilitator/calendar/LessonPlanner'
import LessonEditor from '@/components/LessonEditor'
import LessonNotesModal from '@/app/facilitator/calendar/LessonNotesModal'
import VisualAidsManagerModal from '@/app/facilitator/calendar/VisualAidsManagerModal'
import PortfolioScansModal from '@/app/facilitator/calendar/PortfolioScansModal'
import TypedRemoveConfirmModal from '@/app/facilitator/calendar/TypedRemoveConfirmModal'
import { normalizeLessonKey } from '@/app/lib/lessonKeyNormalization'

export default function CalendarOverlay({ learnerId, learnerGrade, tier, canPlan, accessToken }) {
  const OVERLAY_Z_INDEX = 2147483647

const devStringify = (value) => {
    try {
      if (value instanceof Error) {
        return JSON.stringify({ name: value.name, message: value.message, stack: value.stack })
      }
      return JSON.stringify(value)
    } catch {
      try {
        return String(value)
      } catch {
        return '[unstringifiable]'
      }
    }
  }

const devWarn = (...args) => {
    try {
      if (process.env.NODE_ENV !== 'production') {
        const formatted = (args || []).map((a) => (typeof a === 'string' ? a : devStringify(a)))
        // eslint-disable-next-line no-console
        console.log('[CalendarOverlay]', ...formatted)
      }
    } catch {}
  }

### 38. docs/brain/ingests/pack-mentor-intercepts.md (4165868b5790029e01f7c01d44458476250e5d36cdd1cc5c43972b949e391bb5)
- bm25: -0.6000 | relevance: 1.0000

- API
  - `src/app/api/custom-subjects/route.js`
- Shared subject utilities
  - `src/app/hooks/useFacilitatorSubjects.js`
  - `src/app/lib/subjects.js`
- UI surfaces that must reflect custom subjects
  - `src/app/facilitator/calendar/LessonPicker.js` (scheduler subject filter)
  - `src/app/facilitator/lessons/page.js` (lesson library subject filter)
  - `src/components/LessonEditor.jsx` (lesson subject field)
  - `src/app/facilitator/generator/page.js` (Lesson Maker)
  - `src/app/facilitator/generator/counselor/overlays/*` (Mr. Mentor overlays)

### 39. docs/brain/header-navigation.md (17596087776b8a8510ebd6fdda83503d40ccdb8376bc76c97583cafb2888e681)
- bm25: -0.5987 | relevance: 1.0000

# Header Navigation

## How It Works

The global header (HeaderBar) is rendered across pages and provides:

- Brand link to home
- Back button on pages that define a back chain
- Top-level navigation links (About, Learn, Facilitator)
- Session-specific print menu actions

### Session Print Menu

On the Session page, the header shows a printer icon (desktop layout) that opens a small dropdown with print actions.

**Trigger behavior (desktop):** Open on hover (mouseenter) with a short grace period on mouseleave so it does not flicker closed while moving from the icon into the menu.

**Trigger behavior (touch / fallback):** The icon should also toggle the dropdown on click.

The dropdown includes print actions:

- Worksheet
- Test
- Facilitator Key
- Refresh

On narrow layouts, these same actions live inside the hamburger menu under a nested "Print" section.

Important: header buttons (including the print icon) must explicitly set `type="button"` so they never behave like submit buttons when a page happens to include a form.

Also: header dropdown trigger buttons must call `e.stopPropagation()` in their onClick handlers to prevent the opening click from bubbling to document and immediately triggering the outside-click-close listener.

### Facilitator Dropdown

On non-hamburger layouts, mouseovering the "Facilitator" header link opens a small dropdown menu with quick links:

- ‚öôÔ∏è Account -> `/facilitator/account`
- üîî Notifications -> `/facilitator/notifications`
- üë• Learners -> `/facilitator/learners`
- üìö Lessons -> `/facilitator/lessons`
- üìÖ Calendar -> `/facilitator/calendar`
- üß† Mr. Mentor -> `/facilitator/mr-mentor`

The dropdown uses a short hover grace period on mouseleave so it does not flicker closed while moving from the header link down into the menu.

### 40. src/app/facilitator/generator/counselor/CounselorClient.jsx (a21f786301f175df4d80b37fa98e1a7650a6c8ed13398fc54a8bcad8d5796bed)
- bm25: -0.5982 | relevance: 1.0000

if (!isMountedRef.current) {
          console.log('[Realtime] Ignoring - component unmounted')
          return
        }

const updatedSession = payload.new
        const oldSession = payload.old

// Only process updates for this user's sessions
        if (updatedSession.facilitator_id !== user.id) {
          console.log('[Realtime] Ignoring - different user:', {
            eventUserId: updatedSession.facilitator_id,
            myUserId: user.id
          })
          return
        }

console.log('[Realtime] Session update detected:', { 
          updatedSessionId: updatedSession.session_id, 
          mySessionId,
          isActive: updatedSession.is_active,
          wasActive: oldSession.is_active,
          facilitatorId: updatedSession.facilitator_id,
          deviceName: updatedSession.device_name
        })
